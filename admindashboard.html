<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | IB STUDIOZ</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23FFD700' d='M50,2 A48,48 0 1,0 50,98 A48,48 0 1,0 50,2 Z' /%3E%3Cg fill='%230A0A0A'%3E%3Cpath d='M28,25 h10 v50 h-10 Z' /%3E%3Cpath d='M45,25 H60 A12.5,12.5 0 0,1 60,50 H45 Z M45,50 H63 A12.5,12.5 0 0,1 63,75 H45 Z' /%3E%3C/g%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-glow: #FFD700; --secondary-glow: #00A2FF; --dark-bg: #0A0A0A;
            --text-primary: #F0F0F0; --text-secondary: #A0A0A0; --card-bg: rgba(22, 22, 22, 0.8);
            --border-color: rgba(255, 215, 0, 0.2); --shadow-color: rgba(0, 0, 0, 0.5);
            --danger: #e74c3c; --success: #2ecc71; --info: #3498db;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--dark-bg);
            color: var(--text-primary); line-height: 1.6;
            opacity: 0;
            animation: page-fade-in 0.5s ease-out forwards;
        }
        @keyframes page-fade-in { to { opacity: 1; } }

        /* --- Base, Background, Header, Welcome Styles (No Change) --- */
        .background-container, .aurora-layer, .noise-layer, .container, .page-header, .brand-logo, .header-logo-svg, .brand-title, .brand-title::before, .btn-secondary, .welcome-header-pro { /* Existing Styles */ }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 50px; }
        .nav-card { /* ... existing styles ... */ }

        /* --- Modal and List Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10,10,10,0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 15px; width: 90%; max-width: 800px; padding: 30px; box-shadow: 0 8px 32px 0 var(--shadow-color); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .modal-header h2 { font-size: 1.5rem; }
        .modal-close { background: none; border: none; color: var(--text-primary); font-size: 1.8rem; cursor: pointer; }
        .list-container { max-height: 60vh; overflow-y: auto; }
        .list-item { display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .list-item span.item-title { font-weight: 600; color: var(--text-primary); }
        .list-item span.item-details { font-size: 0.9rem; color: var(--text-secondary); }
        .list-category { font-size: 1.2rem; font-weight: 700; color: var(--primary-glow); margin-top: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);}
        
        /* --- Button and Form Styles for Modals --- */
        .btn-group { display: flex; gap: 10px; }
        .btn-sm { padding: 8px 15px; border-radius: 8px; cursor: pointer; border: none; transition: all 0.3s ease; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-success { background: var(--success); color: white; width: 100%; font-size: 1rem; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: rgba(0,0,0,0.3); color: var(--text-primary); font-family: 'Inter', sans-serif; font-size: 1rem; }
        
        /* --- Analytics Styles --- */
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); text-align: center; }
        .stat-card .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--primary-glow); line-height: 1; }
        .stat-card .stat-label { font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; }

    </style>
</head>
<body>
    <div class="background-container"><!-- ... --></div>

    <main>
        <header class="page-header"><!-- ... --></header>

        <div class="container">
            <div class="welcome-header-pro"><!-- ... --></div>
            <section class="dashboard-grid">
                <a href="/upload.html" class="nav-card" style="--card-color: #2575fc;"><!-- ... --></a>
                <div id="manage-content-card" class="nav-card" style="--card-color: #f857a6;"><!-- ... --></div>
                <div id="manage-users-card" class="nav-card" style="--card-color: #00b09b;"><!-- ... --></div>
                <div id="view-analytics-card" class="nav-card" style="--card-color: #A18CD1;"><div class="nav-card-header"><div class="nav-card-icon"><i class="fas fa-chart-bar"></i></div><span class="nav-card-arrow">â†’</span></div><h3>View Analytics</h3><p>Check resource usage and platform stats.</p></div>
            </section>
        </div>

        <!-- Manage Users Modal -->
        <div id="users-modal" class="modal-overlay">
             <div class="modal">
                <div class="modal-header"><h2>Manage Student Users</h2><button id="users-modal-close-btn" class="modal-close">&times;</button></div>
                <div class="list-container" id="users-list-container"></div>
            </div>
        </div>

        <!-- Manage Content Modal -->
        <div id="content-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header"><h2>Manage Platform Content</h2><button id="content-modal-close-btn" class="modal-close">&times;</button></div>
                <div class="list-container" id="content-list-container"></div>
            </div>
        </div>

        <!-- View Analytics Modal -->
        <div id="analytics-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header"><h2>Platform Analytics</h2><button id="analytics-modal-close-btn" class="modal-close">&times;</button></div>
                <div class="list-container" id="analytics-content-container"></div>
            </div>
        </div>

        <!-- Edit User Modal (hidden by default) -->
        <div id="edit-user-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header"><h2>Modify User</h2><button id="edit-user-modal-close-btn" class="modal-close">&times;</button></div>
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-uid">
                    <div class="form-group"><label for="edit-user-name">Full Name</label><input type="text" id="edit-user-name" required></div>
                    <div class="form-group"><label for="edit-user-admissionNo">Admission No.</label><input type="text" id="edit-user-admissionNo"></div>
                    <button type="submit" class="btn-sm btn-success">Save Changes</button>
                </form>
            </div>
        </div>

        <!-- Edit Content Modal (hidden by default) -->
        <div id="edit-content-modal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header"><h2>Edit Content</h2><button id="edit-content-modal-close-btn" class="modal-close">&times;</button></div>
                <form id="edit-content-form">
                    <input type="hidden" id="edit-content-collection">
                    <input type="hidden" id="edit-content-docId">
                    <div class="form-group"><label for="edit-content-title">Title</label><input type="text" id="edit-content-title" required></div>
                    <div class="form-group"><label for="edit-content-details">Details (Course Code, Speaker, etc.)</label><input type="text" id="edit-content-details"></div>
                    <button type="submit" class="btn-sm btn-success">Save Changes</button>
                </form>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { /* ... Your config ... */ };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // --- Element Selectors for ALL features ---
            const adminNameEl = document.getElementById('admin-name');
            const logoutBtn = document.getElementById('logout-btn');

            const manageUsersCard = document.getElementById('manage-users-card');
            const usersModal = document.getElementById('users-modal');
            const usersModalCloseBtn = document.getElementById('users-modal-close-btn');
            const usersListContainer = document.getElementById('users-list-container');
            
            const manageContentCard = document.getElementById('manage-content-card');
            const contentModal = document.getElementById('content-modal');
            const contentModalCloseBtn = document.getElementById('content-modal-close-btn');
            const contentListContainer = document.getElementById('content-list-container');

            const viewAnalyticsCard = document.getElementById('view-analytics-card');
            const analyticsModal = document.getElementById('analytics-modal');
            const analyticsModalCloseBtn = document.getElementById('analytics-modal-close-btn');
            const analyticsContentContainer = document.getElementById('analytics-content-container');

            const editUserModal = document.getElementById('edit-user-modal');
            const editUserModalCloseBtn = document.getElementById('edit-user-modal-close-btn');
            const editUserForm = document.getElementById('edit-user-form');
            
            const editContentModal = document.getElementById('edit-content-modal');
            const editContentModalCloseBtn = document.getElementById('edit-content-modal-close-btn');
            const editContentForm = document.getElementById('edit-content-form');
            
            // --- Auth Check (no change) ---
            auth.onAuthStateChanged(user => { /* ... */ });
            logoutBtn.addEventListener('click', () => auth.signOut());

            // --- Manage Users Logic ---
            manageUsersCard.addEventListener('click', () => { loadUsers(); usersModal.classList.add('active'); });
            usersModalCloseBtn.addEventListener('click', () => usersModal.classList.remove('active'));
            usersModal.addEventListener('click', e => { if (e.target === usersModal) usersModal.classList.remove('active'); });
            
            async function loadUsers() {
                usersListContainer.innerHTML = '<p>Loading users...</p>';
                const snapshot = await db.collection('users').where('role', '==', 'student').get();
                if (snapshot.empty) { usersListContainer.innerHTML = '<p>No student users found.</p>'; return; }
                
                usersListContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userEl = document.createElement('div');
                    userEl.className = 'list-item';
                    userEl.innerHTML = `
                        <div>
                            <span class="item-title">${user.name}</span><br>
                            <span class="item-details">${user.email} | ${user.admissionNo || 'N/A'}</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn-sm btn-info" data-uid="${doc.id}">Modify</button>
                            <button class="btn-sm btn-danger" data-uid="${doc.id}">Remove</button>
                        </div>
                    `;
                    usersListContainer.appendChild(userEl);
                });
            }

            usersListContainer.addEventListener('click', async (e) => {
                const button = e.target;
                const uid = button.dataset.uid;

                if (button.classList.contains('btn-danger')) { // REMOVE
                    if (confirm(`Are you sure you want to remove this user's record?`)) {
                        await db.collection('users').doc(uid).delete();
                        loadUsers();
                    }
                } else if (button.classList.contains('btn-info')) { // MODIFY
                    const userDoc = await db.collection('users').doc(uid).get();
                    const userData = userDoc.data();
                    document.getElementById('edit-user-uid').value = uid;
                    document.getElementById('edit-user-name').value = userData.name;
                    document.getElementById('edit-user-admissionNo').value = userData.admissionNo || '';
                    editUserModal.classList.add('active');
                }
            });

            editUserModalCloseBtn.addEventListener('click', () => editUserModal.classList.remove('active'));
            editUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const uid = document.getElementById('edit-user-uid').value;
                const newName = document.getElementById('edit-user-name').value;
                const newAdmissionNo = document.getElementById('edit-user-admissionNo').value;
                
                await db.collection('users').doc(uid).update({ name: newName, admissionNo: newAdmissionNo });
                editUserModal.classList.remove('active');
                loadUsers();
            });

            // --- Manage Content Logic ---
            manageContentCard.addEventListener('click', () => { loadAllContent(); contentModal.classList.add('active'); });
            contentModalCloseBtn.addEventListener('click', () => contentModal.classList.remove('active'));
            contentModal.addEventListener('click', e => { if (e.target === contentModal) contentModal.classList.remove('active'); });

            async function loadAllContent() { /* ... (Same as before but add edit button) ... */ 
                contentListContainer.innerHTML = '<p>Loading content...</p>';
                const collections = [{ name: 'materials', title: 'Study Materials' }, { name: 'pyqs', title: 'PYQs & Question Banks' }, { name: 'seminars', title: 'Seminars' }, { name: 'quizzes', title: 'Quizzes' }];
                let allContentHtml = '';
                let totalItems = 0;
                for (const coll of collections) {
                    const snapshot = await db.collection(coll.name).orderBy('uploadedAt', 'desc').get();
                    if (!snapshot.empty) {
                        allContentHtml += `<h3 class="list-category">${coll.title}</h3>`;
                        snapshot.forEach(doc => {
                            totalItems++;
                            const item = doc.data();
                            const details = item.courseCode || item.speaker || item.topic || 'N/A';
                            allContentHtml += `<div class="list-item"><div><span class="item-title">${item.title}</span><br><span class="item-details">${details}</span></div><div class="btn-group"><button class="btn-sm btn-info" data-collection="${coll.name}" data-doc-id="${doc.id}">Edit</button><button class="btn-sm btn-danger" data-collection="${coll.name}" data-doc-id="${doc.id}">Remove</button></div></div>`;
                        });
                    }
                }
                contentListContainer.innerHTML = totalItems > 0 ? allContentHtml : '<p>No content found.</p>';
            }
            
            contentListContainer.addEventListener('click', async (e) => {
                const button = e.target;
                const collection = button.dataset.collection;
                const docId = button.dataset.docId;

                if (button.classList.contains('btn-danger')) { // REMOVE
                     if (confirm(`Are you sure you want to remove this item?`)) {
                        await db.collection(collection).doc(docId).delete();
                        loadAllContent();
                    }
                } else if (button.classList.contains('btn-info')) { // EDIT
                    const doc = await db.collection(collection).doc(docId).get();
                    const item = doc.data();
                    document.getElementById('edit-content-collection').value = collection;
                    document.getElementById('edit-content-docId').value = docId;
                    document.getElementById('edit-content-title').value = item.title;
                    const details = item.courseCode || item.speaker || item.topic || '';
                    document.getElementById('edit-content-details').value = details;
                    editContentModal.classList.add('active');
                }
            });

            editContentModalCloseBtn.addEventListener('click', () => editContentModal.classList.remove('active'));
            editContentForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const collection = document.getElementById('edit-content-collection').value;
                const docId = document.getElementById('edit-content-docId').value;
                const newTitle = document.getElementById('edit-content-title').value;
                const newDetails = document.getElementById('edit-content-details').value;

                const dataToUpdate = { title: newTitle };
                if (collection === 'materials' || collection === 'pyqs') dataToUpdate.courseCode = newDetails;
                else if (collection === 'seminars') dataToUpdate.speaker = newDetails;
                else if (collection === 'quizzes') dataToUpdate.topic = newDetails;

                await db.collection(collection).doc(docId).update(dataToUpdate);
                editContentModal.classList.remove('active');
                loadAllContent();
            });

            // --- Analytics Logic ---
            viewAnalyticsCard.addEventListener('click', () => { loadAnalytics(); analyticsModal.classList.add('active'); });
            analyticsModalCloseBtn.addEventListener('click', () => analyticsModal.classList.remove('active'));
            analyticsModal.addEventListener('click', e => { if (e.target === analyticsModal) analyticsModal.classList.remove('active'); });
            async function loadAnalytics() { /* ... (Same as before) ... */ }
        });
    </script>
</body>
</html>

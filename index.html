<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="IB STUDIOZ - Online Learning Platform Login">
    <meta name="keywords" content="education, learning, materials, courses, login">
    <meta name="author" content="IB STUDIOZ">
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Welcome | IB STUDIOZ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #FFC300; 
            --dark: #121212; 
            --text-primary: #ffffff; 
            --text-secondary: rgba(255, 255, 255, 0.7); 
            --card-bg: rgba(20, 20, 20, 0.7); 
            --border-color: rgba(255, 195, 0, 0.3); 
            --shadow-color: rgba(0, 0, 0, 0.4); 
            --success: #00b09b; 
            --danger: #ff416c; 
            --google: #DB4437;
            --microsoft: #0078D7;
            --info: #3498db;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        /* Dark mode styles */
        body.dark-mode {
            --dark: #f5f5f5;
            --text-primary: #121212;
            --text-secondary: rgba(0, 0, 0, 0.7);
            --card-bg: rgba(255, 255, 255, 0.9);
            --border-color: rgba(255, 195, 0, 0.5);
        }
        
        body.dark-mode .auth-card {
            background: var(--card-bg);
            color: var(--text-primary);
        }
        
        body.dark-mode input, 
        body.dark-mode select {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }
        
        body.dark-mode .btn-secondary {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }
        
        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes background-pan { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes aurora-shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        body { 
            font-family: "Poppins", sans-serif; 
            background-color: var(--dark); 
            color: var(--text-primary); 
            min-height: 100vh; 
            line-height: 1.6; 
            background-attachment: fixed;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- AURORA BACKGROUND ENHANCED --- */
        .aurora-background { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; 
            background: radial-gradient(ellipse at 10% 10%, var(--primary) 0%, rgba(255, 195, 0, 0) 40%), 
                        radial-gradient(ellipse at 90% 85%, #444 0%, rgba(68, 68, 68, 0) 35%),
                        radial-gradient(ellipse at 50% 50%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
            animation: background-pan 45s linear infinite; 
            opacity: 0.3; 
        }
        
        .container { max-width: 1200px; margin: 30px auto; padding: 30px; }
        
        /* --- IB LOGO ENHANCED --- */
        .brand-logo { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            text-decoration: none; 
            color: var(--text-primary);
            transition: transform 0.3s ease;
        }
        .brand-logo:hover {
            transform: scale(1.03);
        }
        .brand-logo img { width: 50px; height: auto; }
        .brand-logo h1 { font-size: 1.5rem; font-weight: 600; margin: 0; }
        
        /* --- BRANDING STYLING --- */
        .brand-title-animated {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(120deg, #ff00c1, #00ffff, #33ff00, #ffc400, #ff00c1);
            background-size: 400% 400%;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: aurora-shimmer 8s ease-in-out infinite;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        
        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 12px 30px; 
            border-radius: 10px; 
            border: none; 
            font-size: 1rem; 
            font-weight: 500; 
            cursor: pointer; 
            text-align: center; 
            transition: all 0.3s ease; 
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: var(--dark); 
            box-shadow: 0 4px 15px rgba(255, 195, 0, 0.3); 
        }
        .btn-primary:hover { 
            transform: translateY(-3px) scale(1.02); 
            box-shadow: 0 6px 20px rgba(255, 195, 0, 0.5); 
        }
        .btn-secondary { 
            background: transparent; 
            color: var(--text-primary); 
            border: 1px solid var(--border-color); 
        }
        .btn-secondary:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateY(-2px);
        }
        .btn-info {
            background: var(--info);
            color: white;
        }
        .btn-small { padding: 8px 15px; font-size: 0.9rem; }
        
        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        /* Social login buttons */
        .btn-google { background: var(--google); color: white; }
        .btn-microsoft { background: var(--microsoft); color: white; }
        .btn-social { margin: 8px 0; width: 100%; }
        .btn-social i { margin-right: 10px; }
        
        .auth-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 90vh;
            animation: fadeInUp 0.8s ease-out;
        }
        
        .auth-card { 
            width: 100%; 
            max-width: 450px; 
            text-align: center; 
            background: var(--card-bg); 
            backdrop-filter: blur(20px);
            border-radius: 15px; 
            border: 1px solid var(--border-color); 
            padding: 40px; 
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            transition: all 0.5s ease;
        }
        
        .auth-card:hover {
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.5);
            transform: translateY(-5px);
        }
        
        .auth-card .brand-logo { justify-content: center; margin-bottom: 5px; }
        .auth-subtitle { color: var(--text-secondary); margin-bottom: 30px; font-size: 1rem; }
        
        #authForm h2 { 
            margin-bottom: 25px; 
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .form-group { 
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInUp 0.5s ease forwards;
        }
        
        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }
        .form-group:nth-child(5) { animation-delay: 0.5s; }
        
        .form-group label { 
            text-align: left; 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .form-group:hover label {
            color: var(--primary);
        }
        
        input, select { 
            width: 100%; 
            padding: 12px 15px; 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            background-color: rgba(0, 0, 0, 0.3); 
            color: var(--text-primary); 
            font-size: 1rem; 
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus { 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(255, 195, 0, 0.3); 
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .auth-card .btn { width: 100%; margin-top: 10px; }
        .toggle-auth { margin-top: 25px; color: var(--text-secondary); }
        .toggle-auth a { color: var(--primary); font-weight: 600; text-decoration: none; cursor: pointer; }
        .message { min-height: 20px; margin-bottom: 15px; font-weight: 500; font-size: 0.9rem; }
        .message.error { color: var(--danger); } 
        .message.success { color: var(--success); }
        .message.info { color: var(--info); }
        
        /* Password strength indicator */
        .password-strength {
            margin-top: 10px;
            display: none;
        }
        
        .strength-bar {
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .strength-fill {
            height: 100%;
            width: 0;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        
        .strength-weak { background: #ff416c; width: 25%; }
        .strength-medium { background: #ffc107; width: 50%; }
        .strength-strong { background: #00b09b; width: 75%; }
        .strength-very-strong { background: #28a745; width: 100%; }
        
        .strength-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        
        /* Button loading state */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn-loading .btn-text {
            visibility: hidden;
        }
        
        .btn-loading .btn-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
        }
        
        .btn-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        .divider span {
            padding: 0 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Forgot Password Link */
        .forgot-password { 
            text-align: right; 
            margin-top: -10px; 
            margin-bottom: 20px; 
        }
        .forgot-password a { 
            color: var(--primary); 
            font-size: 0.9rem; 
            text-decoration: none; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .forgot-password a:hover { 
            text-decoration: underline;
            transform: translateX(3px);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 450px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            transform: translateY(-50px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .modal-close:hover {
            transform: rotate(90deg);
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        .toast.info {
            border-left: 4px solid var(--info);
        }
        
        .toast i {
            font-size: 1.2rem;
        }
        
        .toast.success i {
            color: var(--success);
        }
        
        .toast.error i {
            color: var(--danger);
        }
        
        .toast.info i {
            color: var(--info);
        }
        
        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 480px) {
            .auth-card { padding: 25px; }
            .brand-logo img { width: 40px; }
            .brand-title-animated { font-size: 1.5rem; }
            .container { padding: 15px; margin: 15px auto; }
            .modal { padding: 20px; }
            .dark-mode-toggle {
                width: 40px;
                height: 40px;
            }
        }
        
        .email-display {
            background: rgba(255, 195, 0, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .email-display i {
            color: var(--primary);
            margin-right: 8px;
        }
        
        /* Additional fields for social signup */
        .social-signup-fields {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Form validation styles */
        .form-group.error input, 
        .form-group.error select {
            border-color: var(--danger);
            animation: shake 0.5s ease;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: left;
            display: none;
        }
        .form-group.error .error-message {
            display: block;
        }
        
        /* Page transition effect */
        .page-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.5s ease;
        }
        
        .page-transition.active {
            transform: translateY(0);
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="aurora-background"></div>
    
    <!-- Dark mode toggle -->
    <button class="dark-mode-toggle" id="dark-mode-toggle" title="Toggle dark mode">
        <i class="fas fa-moon"></i>
    </button>
    
    <div class="container auth-container">
        <div class="auth-card">
            <div class="brand-logo">
                <!-- Enhanced IB STUDIOZ logo -->
                <svg width="50" height="50" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#FFD700" />
                            <stop offset="100%" stop-color="#FFA500" />
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="url(#goldGradient)" filter="url(#glow)" />
                    <!-- Redesigned IB letters -->
                    <g fill="#121212" filter="url(#glow)">
                        <!-- Letter I -->
                        <rect x="30" y="25" width="12" height="50" rx="2" />
                        <!-- Letter B -->
                        <path d="M50,25 L50,75 L65,75 C75,75 80,70 80,62 C80,55 75,50 68,50 C75,50 80,45 80,38 C80,30 75,25 65,25 Z M55,35 L65,35 C68,35 70,37 70,40 C70,43 68,45 65,45 L55,45 Z M55,55 L65,55 C68,55 70,57 70,60 C70,63 68,65 65,65 L55,65 Z" />
                    </g>
                </svg>
                <h1 class="brand-title-animated">IB STUDIOZ</h1>
            </div>
            <p class="auth-subtitle">Online Resources Hub</p>
            <form id="authForm" novalidate>
                <h2 id="form-title">Login</h2>
                <div class="form-group" id="name-group" style="display: none;">
                    <label for="name"><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" id="name" placeholder="Enter your full name">
                    <div class="error-message" id="name-error"></div>
                </div>
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="email" placeholder="Enter your email address" required>
                    <div class="error-message" id="email-error"></div>
                </div>
                <div class="form-group" id="admission-group" style="display: none;">
                    <label for="admissionNo"><i class="fas fa-id-card"></i> Admission No</label>
                    <input type="text" id="admissionNo" placeholder="e.g., 717821F123">
                    <div class="error-message" id="admission-error"></div>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" placeholder="Minimum 6 characters" required>
                    <div class="error-message" id="password-error"></div>
                    <div class="password-strength" id="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strength-fill"></div>
                        </div>
                        <div class="strength-text" id="strength-text">Password strength</div>
                    </div>
                </div>
                
                <!-- Additional fields for registration -->
                <div id="registration-fields" style="display: none;">
                    <div class="form-group">
                        <label for="branch"><i class="fas fa-graduation-cap"></i> Branch</label>
                        <select id="branch">
                            <option value="">Select your branch</option>
                            <option value="CSE">Computer Science and Engineering</option>
                            <option value="IT">Information Technology</option>
                            <option value="ECE">Electronics and Communication Engineering</option>
                            <option value="EEE">Electrical and Electronics Engineering</option>
                            <option value="MECH">Mechanical Engineering</option>
                            <option value="CIVIL">Civil Engineering</option>
                            <option value="AERO">Aeronautical Engineering</option>
                            <option value="AUTO">Automobile Engineering</option>
                            <option value="BME">Biomedical Engineering</option>
                            <option value="CHEM">Chemical Engineering</option>
                            <option value="IOT">Internet of Things</option>
                            <option value="AI">Artificial Intelligence</option>
                            <option value="DS">Data Science</option>
                            <option value="CSBS">Computer Science and Business Systems</option>
                        </select>
                        <div class="error-message" id="branch-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="semester"><i class="fas fa-calendar-alt"></i> Semester</label>
                        <select id="semester">
                            <option value="">Select your semester</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                            <option value="4">Semester 4</option>
                            <option value="5">Semester 5</option>
                            <option value="6">Semester 6</option>
                            <option value="7">Semester 7</option>
                            <option value="8">Semester 8</option>
                        </select>
                        <div class="error-message" id="semester-error"></div>
                    </div>
                </div>
                
                <div class="forgot-password">
                    <a id="forgot-password-link">Forgot Password?</a>
                </div>
                <div id="message-area" class="message"></div>
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <span class="btn-text">Login</span>
                    <div class="btn-spinner"></div>
                </button>
                
                <div class="divider">
                    <span>OR</span>
                </div>
                
                <button type="button" class="btn btn-social btn-google" id="google-login">
                    <i class="fab fa-google"></i> Continue with Google
                </button>
                
                <button type="button" class="btn btn-social btn-microsoft" id="microsoft-login">
                    <i class="fab fa-microsoft"></i> Continue with Microsoft
                </button>
            </form>
            <p class="toggle-auth"><span id="toggle-text">Don't have an account?</span> <a id="toggle-link">Register Now</a></p>
        </div>
    </div>
    
    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgot-password-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Reset Password</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="reset-email"><i class="fas fa-envelope"></i> Email Address</label>
                <input type="email" id="reset-email" placeholder="Enter your registered email">
                <div class="error-message" id="reset-email-error"></div>
            </div>
            <div id="reset-message" class="message"></div>
            <button class="btn btn-primary" id="send-reset-btn">
                <span class="btn-text">Send Reset Link</span>
                <div class="btn-spinner"></div>
            </button>
        </div>
    </div>
    
    <div id="spinner" class="spinner-overlay" style="display: none;"><div class="spinner"></div></div>
    
    <!-- Page transition element -->
    <div class="page-transition" id="page-transition"></div>
    
    <!-- Toast container -->
    <div id="toast-container"></div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-google-auth-provider.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-microsoft-auth-provider.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDCmvA9sFCSc5r4ZuFUJuGdO1LDoW7rKao",
            authDomain: "student-portal-free.firebaseapp.com",
            projectId: "student-portal-free",
            storageBucket: "student-portal-free.appspot.com",
            messagingSenderId: "272865877510",
            appId: "1:272865877510:web:0875a2502ae55bbf9ead87"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // DOM Elements
        const authForm = document.getElementById('authForm');
        const messageArea = document.getElementById('message-area');
        const spinner = document.getElementById('spinner');
        const toggleLink = document.getElementById('toggle-link');
        const registrationFields = document.getElementById('registration-fields');
        const pageTransition = document.getElementById('page-transition');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const modalClose = document.getElementById('modal-close');
        const sendResetBtn = document.getElementById('send-reset-btn');
        const resetMessage = document.getElementById('reset-message');
        const resetEmail = document.getElementById('reset-email');
        const resetEmailError = document.getElementById('reset-email-error');
        const googleLoginBtn = document.getElementById('google-login');
        const microsoftLoginBtn = document.getElementById('microsoft-login');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const passwordInput = document.getElementById('password');
        const passwordStrength = document.getElementById('password-strength');
        const strengthFill = document.getElementById('strength-fill');
        const strengthText = document.getElementById('strength-text');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnText = submitBtn.querySelector('.btn-text');
        const submitBtnSpinner = submitBtn.querySelector('.btn-spinner');
        const sendResetBtnText = sendResetBtn.querySelector('.btn-text');
        const sendResetBtnSpinner = sendResetBtn.querySelector('.btn-spinner');
        
        // State variables
        let isLogin = true;
        let isSocialSignup = false;
        let socialUserData = null;
        
        // Load saved theme
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        
        // Dark mode toggle
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });
        
        // Page transition effect
        function navigateToPage(url) {
            pageTransition.classList.add('active');
            setTimeout(() => {
                window.location.href = url;
            }, 500);
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove toast after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }
        
        // Password strength checker
        passwordInput.addEventListener('input', (e) => {
            const password = e.target.value;
            if (password.length === 0) {
                passwordStrength.style.display = 'none';
                return;
            }
            
            passwordStrength.style.display = 'block';
            const strength = checkPasswordStrength(password);
            
            // Remove all strength classes
            strengthFill.className = 'strength-fill';
            
            if (strength <= 1) {
                strengthFill.classList.add('strength-weak');
                strengthText.textContent = 'Weak password';
            } else if (strength === 2) {
                strengthFill.classList.add('strength-medium');
                strengthText.textContent = 'Medium password';
            } else if (strength === 3) {
                strengthFill.classList.add('strength-strong');
                strengthText.textContent = 'Strong password';
            } else {
                strengthFill.classList.add('strength-very-strong');
                strengthText.textContent = 'Very strong password';
            }
        });
        
        function checkPasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.match(/[a-z]+/)) strength++;
            if (password.match(/[A-Z]+/)) strength++;
            if (password.match(/[0-9]+/)) strength++;
            if (password.match(/[$@#&!]+/)) strength++;
            return strength;
        }
        
        // AUTH GUARD: Checks if user is already logged in and redirects them
        auth.onAuthStateChanged(user => {
            if (user) {
                spinner.style.display = 'flex';
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const path = doc.data().role === 'admin' ? '/admindashboard.html' : '/studentdashboard.html';
                        navigateToPage(path);
                    } else {
                        // User is in auth but not DB, log them out to be safe
                        auth.signOut();
                        spinner.style.display = 'none';
                    }
                }).catch(error => {
                    console.error("Error checking user role:", error);
                    auth.signOut();
                    spinner.style.display = 'none';
                });
            }
        });
        
        // Toggles between Login and Register views with animation
        toggleLink.addEventListener('click', () => {
            // Add fade out effect
            authForm.style.opacity = '0';
            authForm.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                isLogin = !isLogin; 
                authForm.reset(); 
                clearErrors();
                messageArea.textContent = '';
                passwordStrength.style.display = 'none';
                document.getElementById('form-title').innerText = isLogin ? 'Login' : 'Register';
                document.getElementById('name-group').style.display = isLogin ? 'none' : 'block';
                document.getElementById('admission-group').style.display = isLogin ? 'none' : 'block';
                document.getElementById('registration-fields').style.display = isLogin ? 'none' : 'block';
                submitBtnText.innerText = isLogin ? 'Login' : 'Register';
                document.getElementById('toggle-text').innerText = isLogin ? "Don't have an account?" : 'Already have an account?';
                document.getElementById('toggle-link').innerText = isLogin ? 'Register Now' : 'Login';
                
                // Hide social signup fields when toggling
                isSocialSignup = false;
                document.getElementById('email').disabled = false;
                
                // Add fade in effect
                authForm.style.opacity = '1';
                authForm.style.transform = 'translateY(0)';
            }, 300);
        });
        
        // Form validation
        function validateForm() {
            clearErrors();
            let isValid = true;
            
            // Email validation
            const email = document.getElementById('email').value.trim();
            if (!email) {
                showError('email', 'Email is required');
                isValid = false;
            } else if (!isValidEmail(email)) {
                showError('email', 'Please enter a valid email address');
                isValid = false;
            }
            
            // Password validation
            const password = document.getElementById('password').value;
            if (!password) {
                showError('password', 'Password is required');
                isValid = false;
            } else if (password.length < 6) {
                showError('password', 'Password must be at least 6 characters');
                isValid = false;
            }
            
            // Registration specific validation
            if (!isLogin) {
                const name = document.getElementById('name').value.trim();
                if (!name) {
                    showError('name', 'Full name is required');
                    isValid = false;
                }
                
                const admissionNo = document.getElementById('admissionNo').value.trim();
                if (!admissionNo) {
                    showError('admission', 'Admission number is required');
                    isValid = false;
                }
                
                const branch = document.getElementById('branch').value;
                if (!branch) {
                    showError('branch', 'Please select your branch');
                    isValid = false;
                }
                
                const semester = document.getElementById('semester').value;
                if (!semester) {
                    showError('semester', 'Please select your semester');
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function showError(field, message) {
            const errorElement = document.getElementById(`${field}-error`);
            errorElement.textContent = message;
            document.getElementById(field === 'admission' ? 'admissionNo' : field).parentElement.classList.add('error');
        }
        
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(el => el.textContent = '');
            
            const formGroups = document.querySelectorAll('.form-group');
            formGroups.forEach(group => group.classList.remove('error'));
        }
        
        // Handles form submission for both Login and Register
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            // Show loading state
            submitBtn.classList.add('btn-loading');
            submitBtnText.style.visibility = 'hidden';
            submitBtnSpinner.style.display = 'block';
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            try {
                if (isLogin) {
                    // Login with email and password
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    // The onAuthStateChanged listener above will handle redirection
                    
                    // Update last login
                    await db.collection('users').doc(userCredential.user.uid).update({
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        loginCount: firebase.firestore.FieldValue.increment(1)
                    });
                    
                } else {
                    const name = document.getElementById('name').value.trim();
                    const admissionNo = document.getElementById('admissionNo').value.trim();
                    const branch = document.getElementById('branch').value;
                    const semester = document.getElementById('semester').value;
                    
                    // Create user with the actual email they provided
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    // Store user data with the actual email
                    const userData = { 
                        name: name, 
                        admissionNo: admissionNo, 
                        email: email,
                        role: 'student',
                        branch: branch,
                        semester: semester,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        loginCount: 1
                    };
                    
                    await db.collection('users').doc(userCredential.user.uid).set(userData);
                    
                    showToast('Registration successful! Please login.', 'success');
                    
                    // Auto switch to login after successful registration
                    setTimeout(() => {
                        toggleLink.click();
                    }, 1500);
                }
            } catch (error) {
                handleAuthError(error);
            } finally {
                submitBtn.classList.remove('btn-loading');
                submitBtnText.style.visibility = 'visible';
                submitBtnSpinner.style.display = 'none';
            }
        });
        
        function handleAuthError(error) {
            console.error("Auth Error:", error);
            let errorMessage = error.message;
            
            // More user-friendly error messages
            if (error.code === 'auth/user-not-found') {
                errorMessage = 'No account found with this email address';
            } else if (error.code === 'auth/wrong-password') {
                errorMessage = 'Incorrect password. Please try again';
            } else if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'This email is already registered. Please login instead';
            } else if (error.code === 'auth/weak-password') {
                errorMessage = 'Password is too weak. Please use a stronger password';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Please enter a valid email address';
            } else if (error.code === 'auth/network-request-failed') {
                errorMessage = 'Network error. Please check your connection and try again';
            }
            
            messageArea.textContent = errorMessage;
            messageArea.className = 'message error';
            spinner.style.display = 'none';
        }
        
        // Forgot Password Implementation
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordModal.classList.add('active');
            resetMessage.textContent = '';
            resetEmail.value = '';
            resetEmailError.textContent = '';
        });
        
        // Close modal
        modalClose.addEventListener('click', () => {
            forgotPasswordModal.classList.remove('active');
        });
        
        // Close modal when clicking outside
        forgotPasswordModal.addEventListener('click', (e) => {
            if (e.target === forgotPasswordModal) {
                forgotPasswordModal.classList.remove('active');
            }
        });
        
        // Send password reset email
        sendResetBtn.addEventListener('click', async () => {
            const email = resetEmail.value.trim();
            
            if (!email) {
                resetEmailError.textContent = 'Please enter your email address';
                return;
            }
            
            if (!isValidEmail(email)) {
                resetEmailError.textContent = 'Please enter a valid email address';
                return;
            }
            
            // Show loading state
            sendResetBtn.classList.add('btn-loading');
            sendResetBtnText.style.visibility = 'hidden';
            sendResetBtnSpinner.style.display = 'block';
            
            try {
                await auth.sendPasswordResetEmail(email);
                
                resetMessage.textContent = 'Password reset email sent! Check your inbox.';
                resetMessage.className = 'message success';
                
                // Close modal after 3 seconds
                setTimeout(() => {
                    forgotPasswordModal.classList.remove('active');
                }, 3000);
            } catch (error) {
                let errorMessage = error.message;
                
                // More user-friendly error messages
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email address';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Please enter a valid email address';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection and try again';
                }
                
                resetMessage.textContent = errorMessage;
                resetMessage.className = 'message error';
            } finally {
                sendResetBtn.classList.remove('btn-loading');
                sendResetBtnText.style.visibility = 'visible';
                sendResetBtnSpinner.style.display = 'none';
            }
        });
        
        // Google Sign-In
        googleLoginBtn.addEventListener('click', async () => {
            spinner.style.display = 'flex';
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                
                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(result.user.uid).get();
                
                if (!userDoc.exists) {
                    // New user, show registration form
                    isSocialSignup = true;
                    socialUserData = {
                        name: result.user.displayName || "Google User",
                        email: result.user.email,
                        provider: "Google"
                    };
                    
                    // Change form to registration mode if not already
                    if (isLogin) {
                        toggleLink.click();
                    }
                    
                    // Pre-fill form fields
                    document.getElementById('name').value = socialUserData.name;
                    document.getElementById('email').value = socialUserData.email;
                    document.getElementById('email').disabled = true;
                    
                    showToast('Please complete your registration with Google', 'info');
                } else {
                    // Existing user, update login info
                    await db.collection('users').doc(result.user.uid).update({
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        loginCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
            } catch (error) {
                console.error("Google sign-in error:", error);
                showToast('Google sign-in failed. Please try again.', 'error');
            } finally {
                spinner.style.display = 'none';
            }
        });
        
        // Microsoft Sign-In
        microsoftLoginBtn.addEventListener('click', async () => {
            spinner.style.display = 'flex';
            
            try {
                const provider = new firebase.auth.OAuthProvider('microsoft.com');
                const result = await auth.signInWithPopup(provider);
                
                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(result.user.uid).get();
                
                if (!userDoc.exists) {
                    // New user, show registration form
                    isSocialSignup = true;
                    socialUserData = {
                        name: result.user.displayName || "Microsoft User",
                        email: result.user.email,
                        provider: "Microsoft"
                    };
                    
                    // Change form to registration mode if not already
                    if (isLogin) {
                        toggleLink.click();
                    }
                    
                    // Pre-fill form fields
                    document.getElementById('name').value = socialUserData.name;
                    document.getElementById('email').value = socialUserData.email;
                    document.getElementById('email').disabled = true;
                    
                    showToast('Please complete your registration with Microsoft', 'info');
                } else {
                    // Existing user, update login info
                    await db.collection('users').doc(result.user.uid).update({
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        loginCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
            } catch (error) {
                console.error("Microsoft sign-in error:", error);
                showToast('Microsoft sign-in failed. Please try again.', 'error');
            } finally {
                spinner.style.display = 'none';
            }
        });
        
        // Handle social registration completion
        document.getElementById('submit-btn').addEventListener('click', async function(e) {
            if (isSocialSignup) {
                e.preventDefault();
                
                if (!validateForm()) {
                    return;
                }
                
                const admissionNo = document.getElementById('admissionNo').value.trim();
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value;
                const branch = document.getElementById('branch').value;
                const semester = document.getElementById('semester').value;
                
                spinner.style.display = 'flex';
                
                try {
                    // Update user document with additional info
                    const userData = {
                        name: name,
                        admissionNo: admissionNo,
                        email: email,
                        role: 'student',
                        branch: branch,
                        semester: semester,
                        provider: socialUserData.provider,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                        loginCount: 1
                    };
                    
                    await db.collection('users').doc(auth.currentUser.uid).set(userData);
                    
                    showToast('Social registration successful!', 'success');
                    
                    // Reset form
                    isSocialSignup = false;
                    document.getElementById('email').disabled = false;
                    
                    // Simulate successful login
                    setTimeout(() => {
                        navigateToPage('/studentdashboard.html');
                    }, 1500);
                } catch (error) {
                    console.error("Social registration error:", error);
                    showToast('Registration failed. Please try again.', 'error');
                    spinner.style.display = 'none';
                }
            }
        });
        
        // Add smooth transitions to form elements
        authForm.style.transition = 'all 0.3s ease';
        
        // Prevent form submission on Enter key for social signup
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && isSocialSignup) {
                e.preventDefault();
                document.getElementById('submit-btn').click();
            }
        });
        
        // Performance monitoring
        if ('PerformanceObserver' in window) {
            const perfObserver = new PerformanceObserver((list) => {
                list.getEntries().forEach(entry => {
                    if (entry.duration > 1000) {
                        console.warn('Slow operation:', entry.name, entry.duration);
                    }
                });
            });
            perfObserver.observe({ entryTypes: ['measure'] });
        }
        
        // Error boundary
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            showToast('An error occurred. Please refresh the page.', 'error');
        });
        
        // Network status monitoring
        window.addEventListener('online', () => {
            showToast('Connection restored', 'success');
        });
        
        window.addEventListener('offline', () => {
            showToast('You are offline. Some features may not work.', 'error');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="IB STUDIOZ - Online Learning Platform">
    <meta name="keywords" content="education, learning, materials, courses, login">
    <meta name="author" content="IB STUDIOZ">
    <meta name="theme-color" content="#1a73e8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>IB STUDIOZ | Enterprise Learning Platform</title>
    
    <!-- Favicon -->
    <link rel="icon" href="https://z-cdn-media.chatglm.cn/files/fdef8460-72eb-426b-999a-55fb65f87dfc_logo%28IB%29.png?auth_key=1789393105-1daab6091e514364812f41e58f215ba1-0-b80b581e4e5006b158843423afacd0eb" type="image/png">
    <link rel="apple-touch-icon" href="https://z-cdn-media.chatglm.cn/files/fdef8460-72eb-426b-999a-55fb65f87dfc_logo%28IB%29.png?auth_key=1789393105-1daab6091e514364812f41e58f215ba1-0-b80b581e4e5006b158843423afacd0eb">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1a73e8; 
            --primary-dark: #1765cc;
            --secondary: #34a853;
            --accent: #fbbc05;
            --dark: #202124; 
            --light: #f8f9fa;
            --text-primary: #202124; 
            --text-secondary: #5f6368; 
            --card-bg: #ffffff; 
            --border-color: #dadce0; 
            --shadow-color: rgba(0, 0, 0, 0.1); 
            --success: #34a853; 
            --danger: #ea4335; 
            --info: #1a73e8;
            --microsoft: #0078D7;
            
            /* Role colors */
            --student-color: #1a73e8;
            --faculty-color: #9c27b0;
            --admin-color: #f44336;
            
            /* Branch colors */
            --cse-color: #1a73e8;
            --it-color: #9c27b0;
            --ece-color: #f44336;
            --eee-color: #ff9800;
            --mech-color: #4caf50;
            --civil-color: #009688;
            --bme-color: #e91e63;
            --ft-color: #ff5722;
            --mct-color: #00bcd4;
            --csd-color: #ff9800;
            --ads-color: #673ab7;
            --efe-color: #795548;
            --exe-color: #607d8b;
            --aiml-color: #009688;
            
            /* Responsive base font size */
            --base-font-size: 16px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html {
            font-size: var(--base-font-size);
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        body { 
            font-family: "Inter", sans-serif; 
            background-color: var(--light); 
            color: var(--text-primary); 
            min-height: 100vh; 
            line-height: 1.6; 
            overflow-x: hidden;
            position: relative;
        }
        
        /* Background pattern */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(26, 115, 232, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(52, 168, 83, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(251, 188, 5, 0.03) 0%, transparent 30%);
            z-index: -1;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 40px 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        /* Header Section */
        .header-section {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease-out;
        }
        
        .logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .logo-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
            transition: transform 0.3s ease;
            background-color: #FFD700; /* Yellow background to match the logo */
            padding: 8px;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .logo:hover .logo-icon {
            transform: translateY(-5px);
        }
        
        .logo-text {
            font-size: 32px;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 20px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        /* Card Styles */
        .auth-card { 
            width: 100%; 
            max-width: 460px; 
            background: var(--card-bg); 
            border-radius: 20px; 
            border: 1px solid var(--border-color); 
            padding: 48px; 
            box-shadow: 0 8px 24px var(--shadow-color);
            transition: all 0.3s ease;
            animation: slideUp 0.6s ease-out;
        }
        
        .auth-card:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 12px;
        }
        
        .card-subtitle {
            color: var(--text-secondary);
            margin-bottom: 36px;
            font-size: 18px;
        }
        
        /* Button Styles */
        .btn { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 14px 24px; 
            border-radius: 10px; 
            border: none; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            text-align: center; 
            transition: all 0.3s ease; 
            text-decoration: none;
            width: 100%;
            position: relative;
            overflow: hidden;
            min-height: 52px;
            margin-bottom: 16px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        
        .btn:hover::before {
            transform: translateX(0);
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .btn-secondary { 
            background: transparent; 
            color: var(--primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover { 
            background: rgba(26, 115, 232, 0.04);
            transform: translateY(-2px);
        }
        
        .btn-microsoft { 
            background: var(--microsoft); 
            color: white; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .btn-microsoft:hover { 
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 215, 0.3);
        }
        
        .btn-microsoft i {
            font-size: 24px;
        }
        
        .btn-icon {
            margin-right: 12px;
        }
        
        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 32px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        
        .divider span {
            padding: 0 16px;
        }
        
        /* Form Styles */
        .form-group { 
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .form-control { 
            width: 100%; 
            padding: 14px 16px; 
            border-radius: 10px; 
            border: 1px solid var(--border-color); 
            background-color: var(--card-bg); 
            color: var(--text-primary); 
            font-size: 16px; 
            transition: all 0.3s ease;
            font-family: "Inter", sans-serif;
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        
        .form-control:hover {
            border-color: var(--primary);
        }
        
        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .checkbox {
            display: none;
        }
        
        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-right: 12px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .checkbox:checked + .checkbox-custom {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .checkbox:checked + .checkbox-custom::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }
        
        .checkbox-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Message Styles */
        .message { 
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            font-size: 14px;
            font-weight: 500;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .message.error { 
            background: rgba(234, 67, 53, 0.1);
            color: var(--danger);
            border: 1px solid rgba(234, 67, 53, 0.2);
        }
        
        .message.success { 
            background: rgba(52, 168, 83, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 168, 83, 0.2);
        }
        
        .message.info { 
            background: rgba(26, 115, 232, 0.1);
            color: var(--info);
            border: 1px solid rgba(26, 115, 232, 0.2);
        }
        
        /* Loading Spinner */
        .spinner-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255, 255, 255, 0.9); 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        
        .spinner-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            animation: pulse 2s infinite;
        }
        
        .spinner { 
            width: 50px; 
            height: 50px; 
            border: 5px solid rgba(26, 115, 232, 0.2); 
            border-radius: 50%; 
            border-top-color: var(--primary); 
            animation: spin 1s ease-in-out infinite; 
        }
        
        .spinner-text {
            margin-top: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Button loading state */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn-loading .btn-text {
            visibility: hidden;
        }
        
        .btn-loading .btn-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: block;
        }
        
        .btn-spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            width: 100%;
            max-width: 540px;
            padding: 40px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            transform: translateY(-30px);
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* Role Selection */
        .role-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        
        .role-option {
            padding: 24px 16px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .role-option:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.1);
            transform: translateY(-3px);
        }
        
        .role-option.selected {
            border-color: var(--primary);
            background: rgba(26, 115, 232, 0.05);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
        }
        
        .role-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .role-option.student .role-icon {
            color: var(--student-color);
        }
        
        .role-option.faculty .role-icon {
            color: var(--faculty-color);
        }
        
        .role-option.admin .role-icon {
            color: var(--admin-color);
        }
        
        .role-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 16px;
        }
        
        .role-description {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Branch Selection */
        .branch-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        
        .branch-item {
            padding: 20px 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .branch-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.1);
            transform: translateY(-3px);
        }
        
        .branch-item.selected {
            border-color: var(--primary);
            background: rgba(26, 115, 232, 0.05);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
        }
        
        .branch-icon {
            font-size: 28px;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .branch-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        /* Semester Selection */
        .semester-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        
        .semester-item {
            padding: 20px 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .semester-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.1);
            transform: translateY(-3px);
        }
        
        .semester-item.selected {
            border-color: var(--primary);
            background: rgba(26, 115, 232, 0.05);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
        }
        
        .semester-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .semester-text {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* User Profile Section */
        .user-profile {
            display: flex;
            align-items: center;
            margin-bottom: 28px;
            padding: 20px;
            background: rgba(26, 115, 232, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(26, 115, 232, 0.1);
        }
        
        .user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            margin-right: 20px;
            flex-shrink: 0;
        }
        
        .user-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .user-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Terms Checkbox */
        .terms-group {
            margin-bottom: 24px;
        }
        
        .terms-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .terms-link:hover {
            text-decoration: underline;
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }
        
        .toast {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 320px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast i {
            font-size: 24px;
        }
        
        .toast.success i {
            color: var(--success);
        }
        
        .toast.error i {
            color: var(--danger);
        }
        
        .toast.info i {
            color: var(--info);
        }
        
        .toast-message {
            flex: 1;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .toast-close:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* Footer */
        .footer {
            margin-top: 48px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 28px;
            margin-top: 16px;
        }
        
        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s ease;
            font-weight: 500;
        }
        
        .footer-links a:hover {
            color: var(--primary);
        }
        
        /* Debug Info */
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
            z-index: 9999;
            max-width: 300px;
            display: none;
        }
        
        /* Animations */
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }
            
            .auth-card {
                padding: 32px 24px;
            }
            
            .role-selection {
                grid-template-columns: 1fr;
            }
            
            .branch-grid, .semester-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .footer-links {
                flex-direction: column;
                gap: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .logo-text {
                font-size: 24px;
            }
            
            .tagline {
                font-size: 16px;
            }
            
            .branch-grid, .semester-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="container">
        <div class="header-section">
            <div class="logo">
                <div class="logo-icon">
                    <img src="https://z-cdn-media.chatglm.cn/files/fdef8460-72eb-426b-999a-55fb65f87dfc_logo%28IB%29.png?auth_key=1789393105-1daab6091e514364812f41e58f215ba1-0-b80b581e4e5006b158843423afacd0eb" alt="IB">
                </div>
                <div class="logo-text">STUDIOZ</div>
            </div>
            <div class="tagline">Enterprise Learning Platform</div>
        </div>
        
        <div class="auth-card">
            <h1 class="card-title">Welcome to IB STUDIOZ</h1>
            <p class="card-subtitle">Sign in with your corporate account</p>
            
            <div id="message-area" class="message" role="alert" aria-live="polite"></div>
            
            <button type="button" class="btn btn-microsoft" id="microsoft-login" aria-label="Login with Microsoft">
                <i class="fab fa-microsoft"></i>
                <span class="btn-text">Sign in with Microsoft</span>
                <div class="btn-spinner"></div>
            </button>
            
            <div class="divider">
                <span>New to IB STUDIOZ?</span>
            </div>
            
            <button type="button" class="btn btn-secondary" id="register-btn">
                <i class="fas fa-user-plus"></i>
                <span class="btn-text">Register with Microsoft</span>
            </button>
            
            <div class="checkbox-group">
                <input type="checkbox" id="remember-me" class="checkbox">
                <label for="remember-me" class="checkbox-custom"></label>
                <label for="remember-me" class="checkbox-label">Remember me</label>
            </div>
        </div>
        
        <div class="footer">
            <p>&copy; 2023 IB STUDIOZ. All rights reserved.</p>
            <div class="footer-links">
                <a href="#" id="terms-link">Terms of Service</a>
                <a href="#" id="privacy-link">Privacy Policy</a>
                <a href="#" id="help-link">Help & Support</a>
            </div>
        </div>
    </div>
    
    <!-- User Profile Modal -->
    <div class="modal-overlay" id="profile-modal" role="dialog" aria-labelledby="profile-title">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="profile-title">Complete Your Profile</h3>
                <button class="modal-close" id="profile-modal-close" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-info">
                    <h3 id="user-name">User Name</h3>
                    <p id="user-email">user@example.com</p>
                </div>
            </div>
            
            <form id="profile-form">
                <div class="form-group">
                    <label class="form-label">Select Your Role</label>
                    <div class="role-selection">
                        <div class="role-option student selected" data-role="student">
                            <div class="role-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="role-name">Student</div>
                            <div class="role-description">Access learning materials</div>
                        </div>
                        <div class="role-option faculty" data-role="faculty">
                            <div class="role-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="role-name">Faculty</div>
                            <div class="role-description">Manage courses</div>
                        </div>
                        <div class="role-option admin" data-role="admin">
                            <div class="role-icon">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div class="role-name">Admin</div>
                            <div class="role-description">System administration</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Your Branch</label>
                    <div class="branch-grid">
                        <div class="branch-item" data-branch="CSE">
                            <div class="branch-icon">
                                <i class="fas fa-laptop-code"></i>
                            </div>
                            <div class="branch-name">CSE</div>
                        </div>
                        <div class="branch-item" data-branch="IT">
                            <div class="branch-icon">
                                <i class="fas fa-network-wired"></i>
                            </div>
                            <div class="branch-name">IT</div>
                        </div>
                        <div class="branch-item" data-branch="ECE">
                            <div class="branch-icon">
                                <i class="fas fa-satellite-dish"></i>
                            </div>
                            <div class="branch-name">ECE</div>
                        </div>
                        <div class="branch-item" data-branch="EEE">
                            <div class="branch-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="branch-name">EEE</div>
                        </div>
                        <div class="branch-item" data-branch="MECH">
                            <div class="branch-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="branch-name">MECH</div>
                        </div>
                        <div class="branch-item" data-branch="CIVIL">
                            <div class="branch-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="branch-name">CIVIL</div>
                        </div>
                        <div class="branch-item" data-branch="BME">
                            <div class="branch-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="branch-name">BME</div>
                        </div>
                        <div class="branch-item" data-branch="AIML">
                            <div class="branch-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="branch-name">AIML</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Your Semester</label>
                    <div class="semester-grid">
                        <div class="semester-item" data-semester="1">
                            <div class="semester-number">1</div>
                            <div class="semester-text">Semester</div>
                        </div>
                        <div class="semester-item" data-semester="2">
                            <div class="semester-number">2</div>
                            <div class="semester-text">Semester</div>
                        </div>
                        <div class="semester-item" data-semester="3">
                            <div class="semester-number">3</div>
                            <div class="semester-text">Semester</div>
                        </div>
                        <div class="semester-item" data-semester="4">
                            <div class="semester-number">4</div>
                            <div class="semester-text">Semester</div>
                        </div>
                        <div class="semester-item" data-semester="5">
                            <div class="semester-number">5</div>
                            <div class="semester-text">Semester</div>
                        </div>
                        <div class="semester-item" data-semester="6">
                            <div class="semester-number">6</div>
                            <div class="semester-text">Semester</div>
                        </div>
                        <div class="semester-item" data-semester="7">
                            <div class="semester-number">7</div>
                            <div class="semester-text">Semester</div>
                        </div>
                        <div class="semester-item" data-semester="8">
                            <div class="semester-number">8</div>
                            <div class="semester-text">Semester</div>
                        </div>
                    </div>
                </div>
                
                <div class="terms-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="terms-checkbox" class="checkbox">
                        <label for="terms-checkbox" class="checkbox-custom"></label>
                        <label for="terms-checkbox" class="checkbox-label">I agree to the <a href="#" class="terms-link" id="terms-link-modal">Terms of Service</a> and <a href="#" class="terms-link" id="privacy-link-modal">Privacy Policy</a></label>
                    </div>
                </div>
                
                <div id="profile-message" class="message" role="alert" aria-live="polite"></div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary" id="save-profile-btn">
                        <i class="fas fa-save"></i>
                        <span class="btn-text">Save Profile</span>
                        <div class="btn-spinner"></div>
                    </button>
                    <button type="button" class="btn btn-secondary" id="skip-profile-btn">
                        <i class="fas fa-forward"></i>
                        <span class="btn-text">Skip for Now</span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="btn-text">Back to Login</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Terms Modal -->
    <div class="modal-overlay" id="terms-modal" role="dialog" aria-labelledby="terms-title">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="terms-title">Terms of Service</h3>
                <button class="modal-close" id="terms-modal-close" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="modal-content">
                <h4>1. Acceptance of Terms</h4>
                <p>By accessing and using IB STUDIOZ, you accept and agree to be bound by the terms and provision of this agreement.</p>
                
                <h4>2. Use License</h4>
                <p>Permission is granted to temporarily download one copy of the materials on IB STUDIOZ for personal, non-commercial transitory viewing only.</p>
                
                <h4>3. Disclaimer</h4>
                <p>The materials on IB STUDIOZ are provided on an 'as is' basis. IB STUDIOZ makes no warranties, expressed or implied, and hereby disclaims and negates all other warranties including without limitation, implied warranties or conditions of merchantability, fitness for a particular purpose, or non-infringement of intellectual property or other violation of rights.</p>
                
                <h4>4. Limitations</h4>
                <p>In no event shall IB STUDIOZ or its suppliers be liable for any damages (including, without limitation, damages for loss of data or profit, or due to business interruption) arising out of the use or inability to use the materials on IB STUDIOZ.</p>
                
                <button class="btn btn-primary" id="accept-terms-btn">I Accept</button>
            </div>
        </div>
    </div>
    
    <!-- Privacy Modal -->
    <div class="modal-overlay" id="privacy-modal" role="dialog" aria-labelledby="privacy-title">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="privacy-title">Privacy Policy</h3>
                <button class="modal-close" id="privacy-modal-close" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="modal-content">
                <h4>Information Collection and Use</h4>
                <p>We collect several different types of information for various purposes to provide and improve our service to you.</p>
                
                <h4>Types of Data Collected</h4>
                <p><strong>Personal Data:</strong> While using our Service, we may ask you to provide us with certain personally identifiable information that can be used to contact or identify you.</p>
                
                <p><strong>Usage Data:</strong> We may also collect information on how the Service is accessed and used.</p>
                
                <h4>Use of Data</h4>
                <p>IB STUDIOZ uses the collected data for various purposes:</p>
                <ul>
                    <li>To provide and maintain the Service</li>
                    <li>To notify you about changes to our Service</li>
                    <li>To provide customer support</li>
                    <li>To monitor the usage of the Service</li>
                    <li>To detect, prevent and address technical issues</li>
                </ul>
                
                <button class="btn btn-primary" id="accept-privacy-btn">I Accept</button>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal" role="dialog" aria-labelledby="help-title">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="help-title">Help & Support</h3>
                <button class="modal-close" id="help-modal-close" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="modal-content">
                <h4>Getting Started</h4>
                <p>If you're new to IB STUDIOZ, follow these steps to get started:</p>
                <ol>
                    <li>Sign in with your Microsoft account</li>
                    <li>Complete your profile with your academic details</li>
                    <li>Browse through the available study materials</li>
                    <li>Join study groups and participate in discussions</li>
                </ol>
                
                <h4>Frequently Asked Questions</h4>
                <p><strong>Q: How do I reset my password?</strong></p>
                <p>A: Use the "Forgot Password" option on the login screen or contact your administrator.</p>
                
                <p><strong>Q: Can I change my email address?</strong></p>
                <p>A: Yes, you can update your email address from your profile settings after logging in.</p>
                
                <p><strong>Q: Is there a mobile app available?</strong></p>
                <p>A: Currently, IB STUDIOZ is available as a web application. We're working on a mobile app and will announce its release soon.</p>
                
                <h4>Contact Support</h4>
                <p>If you need further assistance, please contact our support team at support@ibstudioz.com.</p>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner with Logo -->
    <div id="spinner" class="spinner-overlay" style="display: none;">
        <img src="https://z-cdn-media.chatglm.cn/files/fdef8460-72eb-426b-999a-55fb65f87dfc_logo%28IB%29.png?auth_key=1789393105-1daab6091e514364812f41e58f215ba1-0-b80b581e4e5006b158843423afacd0eb" alt="IB STUDIOZ" class="spinner-logo">
        <div class="spinner"></div>
        <div class="spinner-text">Loading...</div>
    </div>
    
    <!-- Toast container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Debug Info -->
    <div id="debug-info" class="debug-info"></div>
    
    <!-- Include Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://ibthoqjkcfgealypften.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlidGhvcWprY2ZnZWFseXBmdGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDMzNjUsImV4cCI6MjA3MzQxOTM2NX0.Yd-AhgmOzQJEL0h_JndNFD_dF5GtrSA78mh3-ELynis';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        // DOM elements
        const microsoftLoginBtn = document.getElementById('microsoft-login');
        const registerBtn = document.getElementById('register-btn');
        const messageArea = document.getElementById('message-area');
        const spinner = document.getElementById('spinner');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const debugInfo = document.getElementById('debug-info');
        
        // Profile modal elements
        const profileModal = document.getElementById('profile-modal');
        const profileModalClose = document.getElementById('profile-modal-close');
        const profileForm = document.getElementById('profile-form');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const skipProfileBtn = document.getElementById('skip-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileMessage = document.getElementById('profile-message');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const termsCheckbox = document.getElementById('terms-checkbox');
        
        // Modal elements
        const termsModal = document.getElementById('terms-modal');
        const privacyModal = document.getElementById('privacy-modal');
        const helpModal = document.getElementById('help-modal');
        const termsModalClose = document.getElementById('terms-modal-close');
        const privacyModalClose = document.getElementById('privacy-modal-close');
        const helpModalClose = document.getElementById('help-modal-close');
        const acceptTermsBtn = document.getElementById('accept-terms-btn');
        const acceptPrivacyBtn = document.getElementById('accept-privacy-btn');
        
        // Footer links
        const termsLink = document.getElementById('terms-link');
        const privacyLink = document.getElementById('privacy-link');
        const helpLink = document.getElementById('help-link');
        const termsLinkModal = document.getElementById('terms-link-modal');
        const privacyLinkModal = document.getElementById('privacy-link-modal');
        
        // State variables
        let selectedRole = 'student';
        let selectedBranch = null;
        let selectedSemester = null;
        let currentUser = null;
        let termsAccepted = false;
        let privacyAccepted = false;
        let isRegistration = false;
        
        // Debug function
        function debug(message) {
            console.log(message);
            debugInfo.textContent += message + '\n';
            debugInfo.style.display = 'block';
        }
        
        // Clear debug info
        function clearDebug() {
            debugInfo.textContent = '';
            debugInfo.style.display = 'none';
        }
        
        // Toast notification function
        function showToast(message, type = 'info', duration = 5000) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'polite');
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span class="toast-message">${message}</span>
                <button class="toast-close" aria-label="Close notification">&times;</button>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Add close button functionality
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            });
            
            // Remove toast after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        }
        
        // Show spinner
        function showSpinner() {
            spinner.style.display = 'flex';
        }
        
        // Hide spinner
        function hideSpinner() {
            spinner.style.display = 'none';
        }
        
        // Redirect to dashboard based on role
        function redirectToDashboard(role) {
            debug(`Attempting to redirect to dashboard for role: ${role}`);
            
            // Store user data in localStorage for dashboard to use
            if (currentUser) {
                const userData = {
                    id: currentUser.id,
                    email: currentUser.email,
                    name: currentUser.user_metadata.full_name || currentUser.email.split('@')[0],
                    role: role,
                    branch: selectedBranch || 'CSE',
                    semester: selectedSemester || '1'
                };
                localStorage.setItem('ibstudioz_user', JSON.stringify(userData));
                debug(`User data stored in localStorage: ${JSON.stringify(userData)}`);
            }
            
            // Define the dashboard URLs with absolute paths
            const baseUrl = 'https://ib-online-resource-hub.vercel.app';
            const dashboardUrls = {
                admin: `${baseUrl}/admindashboard.html`,
                faculty: `${baseUrl}/facultydashboard.html`,
                student: `${baseUrl}/studentdashboard.html`
            };
            
            const url = dashboardUrls[role] || dashboardUrls.student;
            debug(`Redirect URL: ${url}`);
            
            // Show a loading message
            showToast(`Redirecting to ${role} dashboard...`, 'info');
            
            // Try to redirect to the specific dashboard
            try {
                // Use replace instead of href to prevent back button issues
                window.location.replace(url);
                
                // Fallback: if after 3 seconds we are still on the same page, show an error
                setTimeout(() => {
                    // Check if we're still on the login page by looking for a specific element
                    if (document.getElementById('microsoft-login')) {
                        debug(`Redirection failed, still on login page`);
                        showToast('Failed to redirect to dashboard. Please try again.', 'error');
                    }
                }, 3000);
            } catch (error) {
                debug(`Redirect error: ${error.message}`);
                showToast('Failed to redirect to dashboard. Please try again.', 'error');
            }
        }
        
        // Create user record in Supabase
        async function createUserRecord(userData) {
            try {
                debug(`Creating user record: ${JSON.stringify(userData)}`);
                const { data, error } = await supabase
                    .from('users')
                    .insert([userData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                debug(`User record created successfully: ${JSON.stringify(data)}`);
                return data;
            } catch (error) {
                debug(`Error creating user record: ${error.message}`);
                throw error;
            }
        }
        
        // Update user record in Supabase
        async function updateUserRecord(userId, userData) {
            try {
                debug(`Updating user record for ${userId}: ${JSON.stringify(userData)}`);
                const { data, error } = await supabase
                    .from('users')
                    .update(userData)
                    .eq('id', userId)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                debug(`User record updated successfully: ${JSON.stringify(data)}`);
                return data;
            } catch (error) {
                debug(`Error updating user record: ${error.message}`);
                throw error;
            }
        }
        
        // Get user record from Supabase
        async function getUserRecord(userId) {
            try {
                debug(`Fetching user record for ${userId}`);
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 is the error code for no rows returned
                    throw error;
                }
                
                debug(`User record fetched: ${JSON.stringify(data)}`);
                return data;
            } catch (error) {
                debug(`Error fetching user record: ${error.message}`);
                throw error;
            }
        }
        
        // Create or update user profile in Supabase
        async function saveUserProfile(userData) {
            try {
                debug(`Saving user profile: ${JSON.stringify(userData)}`);
                
                // Check if user record exists
                const existingUser = await getUserRecord(userData.id);
                
                if (existingUser) {
                    // Update existing user record
                    const updatedData = {
                        ...userData,
                        updated_at: new Date()
                    };
                    return await updateUserRecord(userData.id, updatedData);
                } else {
                    // Create new user record
                    const newData = {
                        ...userData,
                        created_at: new Date(),
                        updated_at: new Date()
                    };
                    return await createUserRecord(newData);
                }
            } catch (error) {
                debug(`Error saving user profile: ${error.message}`);
                throw error;
            }
        }
        
        // Microsoft login
        microsoftLoginBtn.addEventListener('click', async () => {
            clearDebug();
            debug('Microsoft login button clicked');
            
            // Show loading
            microsoftLoginBtn.classList.add('btn-loading');
            messageArea.style.display = 'none';
            
            try {
                debug('Attempting Microsoft OAuth sign in');
                // Sign in with Microsoft using OAuth
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'azure',
                    options: {
                        redirectTo: window.location.origin + '?action=login'
                    }
                });
                
                if (error) {
                    throw error;
                }
                
                debug('Microsoft OAuth sign in initiated successfully');
                // The redirect will happen automatically, so we don't need to do anything else here
            } catch (error) {
                debug(`Login error: ${error.message}`);
                console.error('Login error:', error);
                messageArea.textContent = error.message || 'Login failed. Please try again.';
                messageArea.className = 'message error';
                messageArea.style.display = 'block';
                microsoftLoginBtn.classList.remove('btn-loading');
            }
        });
        
        // Microsoft register
        registerBtn.addEventListener('click', async () => {
            clearDebug();
            debug('Microsoft register button clicked');
            
            // Show loading
            registerBtn.classList.add('btn-loading');
            messageArea.style.display = 'none';
            
            try {
                debug('Attempting Microsoft OAuth registration');
                // Sign in with Microsoft using OAuth for registration
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'azure',
                    options: {
                        redirectTo: window.location.origin + '?action=register'
                    }
                });
                
                if (error) {
                    throw error;
                }
                
                debug('Microsoft OAuth registration initiated successfully');
                // The redirect will happen automatically, so we don't need to do anything else here
            } catch (error) {
                debug(`Registration error: ${error.message}`);
                console.error('Registration error:', error);
                messageArea.textContent = error.message || 'Registration failed. Please try again.';
                messageArea.className = 'message error';
                messageArea.style.display = 'block';
                registerBtn.classList.remove('btn-loading');
            }
        });
        
        // Role selection
        document.querySelectorAll('.role-option').forEach(option => {
            option.addEventListener('click', () => {
                // Remove selected class from all options
                document.querySelectorAll('.role-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected class to clicked option
                option.classList.add('selected');
                selectedRole = option.getAttribute('data-role');
                debug(`Role selected: ${selectedRole}`);
            });
        });
        
        // Branch selection
        document.querySelectorAll('.branch-item').forEach(item => {
            item.addEventListener('click', () => {
                // Remove selected class from all items
                document.querySelectorAll('.branch-item').forEach(i => {
                    i.classList.remove('selected');
                });
                
                // Add selected class to clicked item
                item.classList.add('selected');
                selectedBranch = item.getAttribute('data-branch');
                debug(`Branch selected: ${selectedBranch}`);
            });
        });
        
        // Semester selection
        document.querySelectorAll('.semester-item').forEach(item => {
            item.addEventListener('click', () => {
                // Remove selected class from all items
                document.querySelectorAll('.semester-item').forEach(i => {
                    i.classList.remove('selected');
                });
                
                // Add selected class to clicked item
                item.classList.add('selected');
                selectedSemester = item.getAttribute('data-semester');
                debug(`Semester selected: ${selectedSemester}`);
            });
        });
        
        // Save profile
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearDebug();
            debug('Profile form submitted');
            
            // Validate terms acceptance
            if (!termsAccepted || !privacyAccepted) {
                profileMessage.textContent = 'Please accept the Terms of Service and Privacy Policy';
                profileMessage.className = 'message error';
                profileMessage.style.display = 'block';
                return;
            }
            
            // Validate form
            if (!selectedBranch || !selectedSemester) {
                profileMessage.textContent = 'Please select both branch and semester';
                profileMessage.className = 'message error';
                profileMessage.style.display = 'block';
                return;
            }
            
            // Show loading
            saveProfileBtn.classList.add('btn-loading');
            profileMessage.style.display = 'none';
            
            try {
                // Prepare user data
                const userData = {
                    id: currentUser.id,
                    email: currentUser.email,
                    name: currentUser.user_metadata.full_name || currentUser.email.split('@')[0],
                    role: selectedRole,
                    branch: selectedBranch,
                    semester: selectedSemester
                };
                
                debug(`Saving user profile: ${JSON.stringify(userData)}`);
                
                // Save user profile to Supabase
                await saveUserProfile(userData);
                
                // Show success message
                profileMessage.textContent = 'Profile saved successfully! Redirecting...';
                profileMessage.className = 'message success';
                profileMessage.style.display = 'block';
                
                // Redirect based on role
                setTimeout(() => {
                    redirectToDashboard(selectedRole);
                }, 1500);
            } catch (error) {
                debug(`Profile save error: ${error.message}`);
                console.error('Profile save error:', error);
                profileMessage.textContent = error.message || 'Failed to save profile. Please try again.';
                profileMessage.className = 'message error';
                profileMessage.style.display = 'block';
                saveProfileBtn.classList.remove('btn-loading');
            }
        });
        
        // Skip profile completion
        skipProfileBtn.addEventListener('click', async () => {
            clearDebug();
            debug('Skip profile button clicked');
            
            // Show loading
            skipProfileBtn.classList.add('btn-loading');
            
            try {
                // Prepare user data with default values
                const userData = {
                    id: currentUser.id,
                    email: currentUser.email,
                    name: currentUser.user_metadata.full_name || currentUser.email.split('@')[0],
                    role: 'student',
                    branch: 'CSE',
                    semester: '1'
                };
                
                debug(`Saving default user profile: ${JSON.stringify(userData)}`);
                
                // Save user profile to Supabase
                await saveUserProfile(userData);
                
                // Redirect to student dashboard
                redirectToDashboard('student');
            } catch (error) {
                debug(`Skip profile error: ${error.message}`);
                console.error('Profile save error:', error);
                showToast('Failed to save profile. Please try again.', 'error');
                skipProfileBtn.classList.remove('btn-loading');
            }
        });
        
        // Logout
        logoutBtn.addEventListener('click', async () => {
            clearDebug();
            debug('Logout button clicked');
            
            try {
                await supabase.auth.signOut();
                debug('User logged out successfully');
                window.location.reload();
            } catch (error) {
                debug(`Logout error: ${error.message}`);
                console.error('Logout error:', error);
                showToast('Failed to logout. Please try again.', 'error');
            }
        });
        
        // Modal event listeners
        profileModalClose.addEventListener('click', () => {
            profileModal.classList.remove('active');
        });
        
        termsLink.addEventListener('click', (e) => {
            e.preventDefault();
            termsModal.classList.add('active');
        });
        
        privacyLink.addEventListener('click', (e) => {
            e.preventDefault();
            privacyModal.classList.add('active');
        });
        
        helpLink.addEventListener('click', (e) => {
            e.preventDefault();
            helpModal.classList.add('active');
        });
        
        termsLinkModal.addEventListener('click', (e) => {
            e.preventDefault();
            termsModal.classList.add('active');
        });
        
        privacyLinkModal.addEventListener('click', (e) => {
            e.preventDefault();
            privacyModal.classList.add('active');
        });
        
        termsModalClose.addEventListener('click', () => {
            termsModal.classList.remove('active');
        });
        
        privacyModalClose.addEventListener('click', () => {
            privacyModal.classList.remove('active');
        });
        
        helpModalClose.addEventListener('click', () => {
            helpModal.classList.remove('active');
        });
        
        acceptTermsBtn.addEventListener('click', () => {
            termsAccepted = true;
            termsCheckbox.checked = true;
            termsModal.classList.remove('active');
        });
        
        acceptPrivacyBtn.addEventListener('click', () => {
            privacyAccepted = true;
            termsCheckbox.checked = true;
            privacyModal.classList.remove('active');
        });
        
        // Terms checkbox change
        termsCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                termsAccepted = true;
                privacyAccepted = true;
            } else {
                termsAccepted = false;
                privacyAccepted = false;
            }
        });
        
        // Check for existing session on page load
        async function checkSession() {
            clearDebug();
            debug('Checking for existing session');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                if (session) {
                    debug(`Existing session found for user: ${session.user.email}`);
                    // User is logged in, get their role
                    const userId = session.user.id;
                    currentUser = session.user;
                    
                    // Fetch user data from Supabase
                    const userData = await getUserRecord(userId);
                    
                    // Check if this is a registration flow
                    const urlParams = new URLSearchParams(window.location.search);
                    const action = urlParams.get('action');
                    
                    if (action === 'register' || !userData) {
                        debug('New user or registration flow, showing profile modal');
                        // Show profile modal for new users
                        showProfileModal();
                    } else {
                        debug(`Existing user with role: ${userData.role}, redirecting to dashboard`);
                        // Existing user, redirect based on role
                        selectedRole = userData.role;
                        selectedBranch = userData.branch;
                        selectedSemester = userData.semester;
                        redirectToDashboard(userData.role);
                    }
                } else {
                    debug('No existing session found');
                }
            } catch (error) {
                debug(`Session check error: ${error.message}`);
                console.error('Session check error:', error);
            }
        }
        
        // Show profile modal
        function showProfileModal() {
            debug('Showing profile modal');
            
            // Set user info
            const name = currentUser.user_metadata.full_name || currentUser.email.split('@')[0];
            const initial = name.charAt(0).toUpperCase();
            
            userAvatar.textContent = initial;
            userName.textContent = name;
            userEmail.textContent = currentUser.email;
            
            // Reset selections
            selectedRole = 'student';
            selectedBranch = null;
            selectedSemester = null;
            termsAccepted = false;
            privacyAccepted = false;
            
            // Reset UI
            document.querySelectorAll('.role-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector('.role-option.student').classList.add('selected');
            
            document.querySelectorAll('.branch-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            document.querySelectorAll('.semester-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            termsCheckbox.checked = false;
            
            // Show modal
            profileModal.classList.add('active');
        }
        
        // Handle auth state changes
        supabase.auth.onAuthStateChange(async (event, session) => {
            clearDebug();
            debug(`Auth state changed: ${event}`);
            
            if (event === 'SIGNED_IN' && session) {
                debug(`User signed in: ${session.user.email}`);
                // User just signed in, get their role
                const userId = session.user.id;
                currentUser = session.user;
                
                try {
                    // Fetch user data from Supabase
                    const userData = await getUserRecord(userId);
                    
                    // Check if this is a registration flow
                    const urlParams = new URLSearchParams(window.location.search);
                    const action = urlParams.get('action');
                    
                    if (action === 'register' || !userData) {
                        debug('New user or registration flow, showing profile modal');
                        // Show profile modal for new users
                        showProfileModal();
                    } else {
                        debug(`Existing user with role: ${userData.role}, redirecting to dashboard`);
                        // User exists, redirect based on role
                        selectedRole = userData.role;
                        selectedBranch = userData.branch;
                        selectedSemester = userData.semester;
                        redirectToDashboard(userData.role);
                    }
                } catch (error) {
                    debug(`Error during auth state change: ${error.message}`);
                    console.error('Error during auth state change:', error);
                }
            }
        });
        
        // Check session on page load
        checkSession();
        
        // Add debug toggle
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Access and manage your study materials at IB STUDIOZ">
    <meta property="og:title" content="Study Materials - IB STUDIOZ">
    <meta property="og:description" content="Access your study materials, notes, and resources">
    <meta property="og:type" content="website">
    <title>Study Materials - IB STUDIOZ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>

    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --background: #ffffff;
            --surface: #f8fafc;
            --surface-hover: #f1f5f9;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 0.75rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Branch Colors */
            --cse-color: #3b82f6;
            --it-color: #8b5cf6;
            --ece-color: #10b981;
            --eee-color: #f59e0b;
            --mech-color: #ef4444;
            --aiml-color: #06b6d4;
            --civil-color: #0ea5e9;
            --bme-color: #ec4899;
            --ft-color: #8b5cf6;
            --mct-color: #f97316;
            --csd-color: #a855f7;
            --ads-color: #0ea5e9;
            --efe-color: #10b981;
            --exe-color: #8b5cf6;
        }
        
        [data-theme="dark"] {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --secondary: #a78bfa;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-hover: #334155;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }
        
        /* Background Effects */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(135deg, var(--background) 0%, var(--surface) 100%);
        }
        
        .aurora-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 20%, var(--primary) 0%, transparent 30%),
                        radial-gradient(circle at 80% 80%, var(--secondary) 0%, transparent 30%);
            animation: aurora-morph 20s ease-in-out infinite alternate;
            filter: blur(100px);
            opacity: 0.1;
        }
        
        @keyframes aurora-morph {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(180deg) scale(1.2); }
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition);
        }
        
        [data-theme="dark"] .header {
            background: rgba(15, 23, 42, 0.8);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-link {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }
        
        .nav-link:hover {
            color: var(--primary);
        }
        
        .nav-link.active {
            color: var(--primary);
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -1.5rem;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-outline:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-special {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .btn-special::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .btn-special:hover::before {
            transform: translateX(0);
        }
        
        .btn-special:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .theme-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .theme-toggle:hover {
            background: var(--surface-hover);
            border-color: var(--primary);
        }
        
        /* Account Dropdown */
        .account-dropdown {
            position: relative;
        }
        
        .account-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 320px;
            max-width: 90vw;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .account-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Updated: Responsive account menu */
        @media (max-width: 768px) {
            .account-menu {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                width: 300px;
                border-radius: 0;
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .account-menu.active {
                transform: translateX(0);
            }
        }
        
        .account-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        
        .account-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0 auto 1rem;
            overflow: hidden;
            position: relative;
        }
        
        .account-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .account-info {
            text-align: center;
        }
        
        .account-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .account-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .account-brand {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .account-edit-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--surface-hover);
            border: 1px solid var(--border);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }
        
        .account-edit-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .account-content {
            padding: 1rem;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .account-section {
            margin-bottom: 1.5rem;
        }
        
        .account-section:last-child {
            margin-bottom: 0;
        }
        
        .account-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 0.5rem;
        }
        
        .account-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .account-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: calc(var(--radius) / 2);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .account-item:hover {
            background: var(--surface-hover);
        }
        
        .account-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-hover);
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .account-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .account-item-title {
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .account-item-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .account-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
        }
        
        /* Profile Edit Form */
        .profile-edit-form {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: none;
        }
        
        .profile-edit-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--background);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Welcome Section */
        .welcome-section {
            margin-bottom: 2rem;
        }
        
        .welcome-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .welcome-content {
            position: relative;
            z-index: 1;
        }
        
        .welcome-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        
        .welcome-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            max-width: 600px;
        }
        
        .welcome-illustration {
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            opacity: 0.1;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
        }
        
        /* Filter Section */
        .filter-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .filter-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .filter-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .filter-select, .filter-input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--background);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition);
        }
        
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Branch-Semester-Course Selection Display */
        .selection-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--surface-hover);
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .selection-item {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            background: var(--background);
            border-radius: calc(var(--radius) / 2);
        }
        
        .selection-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        
        .selection-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .change-selection-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0.75rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .change-selection-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Materials Grid */
        .materials-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .materials-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .materials-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .material-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }
        
        .material-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .material-thumbnail {
            height: 180px;
            background: linear-gradient(135deg, var(--surface-hover) 0%, var(--border) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--text-muted);
            position: relative;
            overflow: hidden;
        }
        
        .material-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .material-type-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        .material-content {
            padding: 1.5rem;
        }
        
        .material-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
            line-height: 1.3;
        }
        
        .material-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .material-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .material-branch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .material-branch-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .material-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .material-action {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-hover);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .material-action:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .material-action.favorite.active {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .empty-description {
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 4rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Branch-Semester-Course Selection Modal */
        .branch-semester-course-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .branch-semester-course-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .branch-semester-course-modal .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 90%;
            max-width: 900px;
            padding: 0;
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition: var(--transition);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .branch-semester-course-modal.active .modal {
            transform: translateY(0);
        }
        
        .selection-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selection-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }
        .selection-steps {
            display: flex;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step:not(:last-child):after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border);
            z-index: -1;
        }
        
        .step.active:not(:last-child):after {
            background: var(--primary);
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--surface-hover);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 600;
            border: 2px solid var(--border);
            position: relative;
        }
        
        .step.active .step-number {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .step-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .step.active .step-title {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .selection-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .selection-step {
            display: none;
        }
        
        .selection-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .selection-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .selection-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .selection-card.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }
        
        .selection-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        .selection-card.selected .selection-icon {
            color: white;
        }
        
        .selection-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .selection-code {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        .selection-card.selected .selection-code {
            opacity: 0.9;
        }
        
        .selection-actions {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            background: var(--surface);
        }
        
        .btn-step {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }
        .btn-step:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-prev {
            background: var(--surface-hover);
            color: var(--text-primary);
        }
        
        .btn-prev:hover:not(:disabled) {
            background: var(--border);
        }
        
        .btn-next, .btn-finish {
            background: var(--primary);
            color: white;
        }
        
        .btn-next:hover:not(:disabled), .btn-finish:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        
        .btn-finish {
            display: none;
        }
        
        /* Chatbot Styles */
        .chatbot-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 99;
            box-shadow: var(--shadow-xl);
            color: white;
            font-weight: 600;
            transition: var(--transition);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chatbot-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }

        .chatbot-container {
            position: fixed;
            bottom: 6rem;
            right: 1.5rem;
            width: 90%;
            max-width: 400px;
            height: 500px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-xl);
            z-index: 98;
            display: flex;
            flex-direction: column;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .chatbot-container.active {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .chatbot-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            text-align: center;
            background: var(--surface);
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chatbot-close, .chatbot-reset {
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chatbot-close:hover, .chatbot-reset:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            -webkit-overflow-scrolling: touch;
        }
        
        .message-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .message-row.bot .bot-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            animation: messageSlide 0.3s ease;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        
        .message.bot {
            background: var(--surface-hover);
            color: var(--text-primary);
            border-bottom-left-radius: 0.25rem;
        }
        
        /* Updated: Code block styling */
        .message .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 0.75rem;
            border-radius: var(--radius);
            font-size: 0.8rem;
            margin: 0.5rem 0;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
        }

        /* Updated: Loading state with three floating dots */
        .message.loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-style: italic;
            color: var(--text-muted);
        }
        
        .message.loading .spinner {
            width: 16px;
            height: 16px;
            border-width: 2px;
            border-top: 2px solid var(--text-muted); /* Make the spinner visible on the gray background */
        }
        
        /* Updated: Message streaming / typewriter effect */
        .typing::after {
            content: '|';
            animation: blink-caret .75s step-end infinite;
        }
        
        @keyframes blink-caret {
            from, to { color: transparent; }
            50% { color: var(--text-primary); }
        }
        
        .chatbot-input {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        
        .chatbot-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--background);
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .chatbot-input input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .chatbot-send {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .chatbot-send:hover {
            background: var(--primary-dark);
        }
        
        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            transition: var(--transition);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        .toast.info {
            border-left: 4px solid var(--info);
        }
        
        .toast-icon {
            font-size: 1.25rem;
        }
        
        .toast.success .toast-icon {
            color: var(--success);
        }
        
        .toast.error .toast-icon {
            color: var(--danger);
        }
        
        .toast.info .toast-icon {
            color: var(--info);
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .header-content { padding: 1rem; }
            .container { padding: 1rem; }
            .nav-links { display: none; }
            .welcome-title { font-size: 1.5rem; }
            .filter-grid { grid-template-columns: 1fr; }
            .materials-grid { grid-template-columns: 1fr; }
            .chatbot-container { right: 1rem; left: 1rem; max-width: none; }
            .modal { width: 95%; max-height: 95vh; }
            .account-menu { width: 280px; }
            .materials-header { flex-direction: column; align-items: flex-start; }
            .chatbot-toggle { bottom: 1rem; right: 1rem; width: 50px; height: 50px; font-size: 1.2rem; }
            .selection-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .selection-card { padding: 1rem; }
            .selection-icon { font-size: 1.5rem; }
            .account-menu {
                width: 90vw;
                right: 5vw;
            }
        }
        
        @media (max-width: 480px) {
            .filter-section { padding: 1rem; }
            .filter-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .filter-actions { width: 100%; justify-content: space-between; }
            .btn { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
            .material-actions { flex-wrap: wrap; }
            .material-action { width: 32px; height: 32px; }
            .account-header {
                padding: 1rem;
            }
            .account-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            .account-content {
                max-height: 40vh;
            }
            .account-item {
                padding: 0.5rem;
            }
            .account-item-icon {
                width: 36px;
                height: 36px;
            }
            .chatbot-container {
                height: 70vh;
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="background-container">
        <div class="aurora-layer"></div>
    </div>
    
    <header class="header">
        <div class="header-content">
            <a href="studentdashboard.html" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                IB STUDIOZ
            </a>
            
            <nav class="nav-links">
                <a href="studentdashboard.html" class="nav-link">
                    <button class="btn btn-special">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </button>
                </a>
                <a href="materials.html" class="nav-link active">Materials</a>
                <a href="pyq.html" class="nav-link">PYQs</a>
                <a href="seminar.html" class="nav-link">Seminars</a>
                <a href="quiz.html" class="nav-link">Quizzes</a>
                <a href="cgpa.html" class="nav-link">GPA Calculator</a>
            </nav>
            
            <div class="header-actions">
                <div class="account-dropdown">
                    <button class="btn btn-outline" id="accountBtn">
                        <i class="fas fa-user"></i>
                        <span>Account</span>
                    </button>
                    <div class="account-menu" id="accountMenu">
                        <div class="account-header">
                            <div class="account-avatar" id="accountAvatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="account-info">
                                <h3 id="accountName">Loading...</h3>
                                <p id="accountEmail">Loading...</p>
                                <p class="account-brand">IB STUDIOZ</p>
                            </div>
                            <button class="account-edit-btn" id="editProfileBtn">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        
                        <div class="profile-edit-form" id="profileEditForm">
                            <div class="form-group">
                                <label class="form-label" for="displayNameInput">Display Name</label>
                                <input type="text" id="displayNameInput" class="form-input" placeholder="Enter your name">
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-outline" id="cancelEditBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveProfileBtn">Save</button>
                            </div>
                        </div>
                        
                        <div class="account-content">
                            <div class="account-section">
                                <div class="account-section-title">Account Details</div>
                                <div class="account-list">
                                    <div class="account-item">
                                        <div class="account-item-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="account-item-info">
                                            <div class="account-item-title">Full Name</div>
                                            <div class="account-item-meta" id="accountFullName">Not set</div>
                                        </div>
                                    </div>
                                    <div class="account-item">
                                        <div class="account-item-icon">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <div class="account-item-info">
                                            <div class="account-item-title">Email</div>
                                            <div class="account-item-meta" id="accountEmailDetail">Loading...</div>
                                        </div>
                                    </div>
                                    <div class="account-item">
                                        <div class="account-item-icon">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        <div class="account-item-info">
                                            <div class="account-item-title">Member Since</div>
                                            <div class="account-item-meta" id="accountMemberSince">Loading...</div>
                                        </div>
                                    </div>
                                    <div class="account-item">
                                        <div class="account-item-icon">
                                            <i class="fas fa-download"></i>
                                        </div>
                                        <div class="account-item-info">
                                            <div class="account-item-title">Downloads</div>
                                            <div class="account-item-meta" id="accountDownloads">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="account-section">
                                <div class="account-section-title">Downloaded Materials</div>
                                <div class="account-list" id="downloadedMaterials">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="account-section">
                                <div class="account-section-title">Account Settings</div>
                                <div class="account-list">
                                    <div class="account-item" id="preferencesBtn">
                                        <div class="account-item-icon">
                                            <i class="fas fa-cog"></i>
                                        </div>
                                        <div class="account-item-info">
                                            <div class="account-item-title">Preferences</div>
                                        </div>
                                    </div>
                                    <div class="account-item" id="privacyBtn">
                                        <div class="account-item-icon">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <div class="account-item-info">
                                            <div class="account-item-title">Privacy</div>
                                        </div>
                                    </div>
                                    <div class="account-item" id="helpBtn">
                                        <div class="account-item-icon">
                                            <i class="fas fa-question-circle"></i>
                                        </div>
                                        <div class="account-item-info">
                                            <div class="account-item-title">Help & Support</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="account-footer">
                            <button class="btn btn-primary" id="accountLogout">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </header>
    
    <main class="container">
        <div class="welcome-section">
            <div class="welcome-card">
                <div class="welcome-content">
                    <h1 class="welcome-title">
                        Study Materials
                    </h1>
                    <p class="welcome-subtitle">
                        Access notes, e-books, slides, and other learning resources for your courses.
                    </p>
                </div>
                <div class="welcome-illustration"></div>
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-header">
                <h2 class="filter-title">Filter Materials</h2>
                <div class="filter-actions">
                    <button class="btn btn-outline" id="advancedFilterBtn">
                        <i class="fas fa-filter"></i>
                        <span>Advanced Filters</span>
                    </button>
                    <button class="btn btn-outline" id="resetFilters">
                        <i class="fas fa-redo"></i>
                        <span>Reset</span>
                    </button>
                </div>
            </div>
            <div class="selection-display" id="selection-display" style="display: none;">
                <div class="selection-item">
                    <div class="selection-label">Branch</div>
                    <div class="selection-value" id="selected-branch">-</div>
                </div>
                <div class="selection-item">
                    <div class="selection-label">Semester</div>
                    <div class="selection-value" id="selected-semester">-</div>
                </div>
                <div class="selection-item">
                    <div class="selection-label">Course</div>
                    <div class="selection-value" id="selected-course">-</div>
                </div>
                <button class="change-selection-btn" id="change-selection">
                    <i class="fas fa-edit"></i>
                    <span>Change</span>
                </button>
            </div>
            
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">Search</label>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Search by title or description...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Material Type</label>
                    <select class="filter-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="notes">Notes</option>
                        <option value="ebook">E-Books</option>
                        <option value="slides">Slides</option>
                        <option value="video">Videos</option>
                        <option value="lab">Lab Manuals</option>
                        <option value="project">Projects</option>
                    </select>
                </div>
                <div class="filter-group" style="display:none;">
                    <label class="filter-label">Branch</label>
                    <select class="filter-select" id="branchFilter"></select>
                </div>
                <div class="filter-group" style="display:none;">
                    <label class="filter-label">Semester</label>
                    <select class="filter-select" id="semesterFilter"></select>
                </div>
                <div class="filter-group" style="display:none;">
                    <label class="filter-label">Course</label>
                    <select class="filter-select" id="courseFilter"></select>
                </div>
            </div>
        </div>
        
        <div class="materials-header">
            <div>
                <h2 class="materials-title">Available Materials</h2>
                <p class="materials-count" id="materialsCount">Loading materials...</p>
            </div>
        </div>
        
        <div class="materials-grid" id="materialsGrid">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </main>
    
    <div class="branch-semester-course-modal" id="branch-semester-course-modal">
        <div class="modal">
            <div class="selection-header">
                <h2>Select Your Course</h2>
                <button class="modal-close" id="selection-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="selection-steps">
                <div class="step active" data-step="branch">
                    <div class="step-number">1</div>
                    <div class="step-title">Branch</div>
                </div>
                <div class="step" data-step="semester">
                    <div class="step-number">2</div>
                    <div class="step-title">Semester</div>
                </div>
                <div class="step" data-step="course">
                    <div class="step-number">3</div>
                    <div class="step-title">Course</div>
                </div>
            </div>
            
            <div class="selection-content">
                <div class="selection-step active" id="branch-step">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Select Your Branch</h3>
                    <div class="selection-grid" id="branch-options">
                        </div>
                </div>
                
                <div class="selection-step" id="semester-step">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Select Your Semester</h3>
                    <div class="selection-grid" id="semester-options">
                        </div>
                </div>
                
                <div class="selection-step" id="course-step">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Select Your Course</h3>
                    <div class="selection-grid" id="course-options">
                        </div>
                </div>
            </div>
            
            <div class="selection-actions">
                <button class="btn-step btn-prev" id="prev-step-btn" style="display: none;">Previous</button>
                <button class="btn-step btn-next" id="next-step-btn" disabled>Next</button>
                <button class="btn-step btn-finish" id="finish-selection-btn" disabled>Finish</button>
            </div>
        </div>
    </div>
    
    <button class="chatbot-toggle" id="chatbotToggle">
        <div style="font-size: 1.2rem; font-weight: 700;">IB</div>
    </button>
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <div>
                <i class="fas fa-robot"></i> IB Assistant
            </div>
            <div>
                <button class="chatbot-reset" id="chatbotReset" title="Clear Chat">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="chatbot-close" id="chatbotClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            </div>
        <div class="chatbot-input">
            <input type="text" id="chatbotInput" placeholder="Ask a question...">
            <button class="chatbot-send" id="chatbotSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <div class="toast" id="toast">
        <i class="fas fa-check-circle toast-icon"></i>
        <span id="toastMessage">Notification message</span>
    </div>
    
    <script>
        // Academic Data
        const academicData = {
            branches: {
                "CSE": {"name":"Computer Science Engineering","color":"var(--cse-color)","icon":"fas fa-laptop-code","semesters":{"1":[{"code":"U23ENG101A","name":"Communication Skills in English","credits":3},{"code":"U23MAT102A","name":"Linear Algebra and Calculus With MATLAB","credits":4},{"code":"U23PHY103B","name":"Engineering Physics","credits":3},{"code":"U23PPR105","name":"Problem Solving using Python Programming","credits":3},{"code":"U23BEE106A","name":"Basic Electrical and Electronics Engineering","credits":3},{"code":"U23TAM101","name":"Heritage of Tamils","credits":1},{"code":"U23PHL110","name":"Engineering Physics Lab","credits":1},{"code":"U23BEEL113","name":"Basic Electrical and Electronics Engineering Lab","credits":1},{"code":"U23PPL112","name":"Python Programming Lab","credits":1}],"2":[{"code":"U23ENG201A","name":"Technical English","credits":2},{"code":"U23MAT202B","name":"Discrete Mathematics","credits":4},{"code":"U23CHE204B","name":"Chemistry For Computer Science","credits":3},{"code":"U23CPR205B","name":"Programming In C","credits":3},{"code":"U23EGR207","name":"Engineering Graphics","credits":3},{"code":"U23EC203","name":"Digital Principles And System Design","credits":3},{"code":"U23CHL211","name":"Chemistry Lab","credits":1},{"code":"U23CPL212","name":"C programming Lab","credits":1},{"code":"U23TAM201","name":"Tamils And Technology","credits":1}],"3":[{"code":"U23MAT301D","name":"Probability and Statistics","credits":4},{"code":"U23CS301","name":"Data Structures","credits":3},{"code":"U23CS302","name":"Computer Architecture","credits":3},{"code":"U23CS303","name":"Object Oriented Programming","credits":3},{"code":"U23CS304","name":"Operating Systems","credits":3},{"code":"U23CS305","name":"Computer Information and Ethics","credits":3},{"code":"U23CS306","name":"Data Structures Lab","credits":1},{"code":"U23CS307","name":"Object Oriented Programming Lab","credits":1},{"code":"U23GE301","name":"Soft Skills and Aptitude-I","credits":1},{"code":"Noc24-mg72","name":"NPTEL:design Thinking-A Primer","credits":1}],"4":[{"code":"U23MAT401B","name":"Numerical Methods","credits":4},{"code":"U23CS401","name":"Design And Analysis of Algorithms","credits":3},{"code":"U23CS402","name":"Software Engineering","credits":3},{"code":"U23CS403","name":"DataBase Management Systems","credits":3},{"code":"U23CS404","name":"Embedded System Design ","credits":3},{"code":"U23CS405","name":"Software Development Lab","credits":1},{"code":"U23CS403","name":"Database Management Systems Lab","credits":1}],"5":[{"code":"U23CS504","name":"Machine Learning","credits":3},{"code":"U23CS501","name":"Computer Networks","credits":3},{"code":"U23CS502","name":"Artificial Intelligence","credits":3},{"code":"U23CS503","name":"Theory of Computation","credits":3},{"code":"noc25-cs135","name":"Elective NPTEL","credits":3},{"code":" U23CS947 / U23CS903","name":"Professional Elective ","credits":3},{"code":"U23CS505","name":"Computer Networks Laboratory","credits":2},{"code":"U23CS506","name":"Artificial Intelligence and Machine Learning Laboratory","credits":1},{"code":"U23GE501","name":"Soft Skills and Aptitude -III","credits":1}],"6":[],"7":[],"8":[]}},
                "IT": {"name":"Information Technology","color":"var(--it-color)","icon":"fas fa-network-wired","semesters":{"1":[{"code":"U23IT101","name":"Programming Fundamentals","credits":4},{"code":"U23IT102","name":"Discrete Mathematics","credits":4},{"code":"U23IT103","name":"Digital Systems","credits":3},{"code":"U23IT104","name":"Computer Organization","credits":3},{"code":"U23IT105","name":"Communication Skills","credits":2},{"code":"U23IT106","name":"Programming Lab","credits":1},{"code":"U23IT107","name":"Digital Systems Lab","credits":1}],"2":[{"code":"U23IT201","name":"Data Structures","credits":4},{"code":"U23IT202","name":"Database Systems","credits":4},{"code":"U23IT203","name":"Operating Systems","credits":3},{"code":"U23IT204","name":"Computer Networks","credits":3},{"code":"U23IT205","name":"Web Technologies","credits":3},{"code":"U23IT206","name":"Data Structures Lab","credits":1},{"code":"U23IT207","name":"Web Technologies Lab","credits":1}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
                "ECE": {"name":"Electronics & Communication Engineering","color":"var(--ece-color)","icon":"fas fa-satellite-dish","semesters":{"1":[{"code":"U23EC101","name":"Basic Electronics","credits":4},{"code":"U23EC102","name":"Circuit Theory","credits":4},{"code":"U23EC103","name":"Engineering Mathematics","credits":4},{"code":"U23EC104","name":"Programming in C","credits":3},{"code":"U23EC105","name":"Communication Skills","credits":2},{"code":"U23EC106","name":"Electronics Lab","credits":1},{"code":"U23EC107","name":"Programming Lab","credits":1}],"2":[{"code":"U23EC201","name":"Analog Electronics","credits":4},{"code":"U23EC202","name":"Digital Electronics","credits":4},{"code":"U23EC203","name":"Signals and Systems","credits":4},{"code":"U23EC204","name":"Electromagnetic Theory","credits":3},{"code":"U23EC205","name":"Data Structures","credits":3},{"code":"U23EC206","name":"Analog Electronics Lab","credits":1},{"code":"U23EC207","name":"Digital Electronics Lab","credits":1}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
                "EEE": {"name":"Electrical & Electronics Engineering","color":"var(--eee-color)","icon":"fas fa-bolt","semesters":{"1":[{"code":"U23EE101","name":"Basic Electrical Engineering","credits":4},{"code":"U23EE102","name":"Engineering Mathematics","credits":4},{"code":"U23EE103","name":"Electronics Engineering","credits":3},{"code":"U23EE104","name":"Programming in C","credits":3},{"code":"U23EE105","name":"Communication Skills","credits":2},{"code":"U23EE106","name":"Electrical Lab","credits":1},{"code":"U23EE107","name":"Programming Lab","credits":1}],"2":[{"code":"U23EE201","name":"Circuit Theory","credits":4},{"code":"U23EE202","name":"Electromagnetic Theory","credits":4},{"code":"U23EE203","name":"Digital Electronics","credits":4},{"code":"U23EE204","name":"Electrical Machines","credits":3},{"code":"U23EE205","name":"Data Structures","credits":3},{"code":"U23EE206","name":"Circuit Theory Lab","credits":1},{"code":"U23EE207","name":"Digital Electronics Lab","credits":1}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
                "MECH": {"name":"Mechanical Engineering","color":"var(--mech-color)","icon":"fas fa-cogs","semesters":{"1":[{"code":"U23ME101","name":"Engineering Mechanics","credits":4},{"code":"U23ME102","name":"Engineering Graphics","credits":4},{"code":"U23ME103","name":"Engineering Mathematics","credits":4},{"code":"U23ME104","name":"Basic Electrical Engineering","credits":3},{"code":"U23ME105","name":"Communication Skills","credits":2},{"code":"U23ME106","name":"Workshop Practice","credits":1},{"code":"U23ME107","name":"Engineering Graphics Lab","credits":1}],"2":[{"code":"U23ME201","name":"Thermodynamics","credits":4},{"code":"U23ME202","name":"Mechanics of Materials","credits":4},{"code":"U23ME203","name":"Manufacturing Technology","credits":4},{"code":"U23ME204","name":"Fluid Mechanics","credits":3},{"code":"U23ME205","name":"Computer Programming","credits":3},{"code":"U23ME206","name":"Thermodynamics Lab","credits":1},{"code":"U23ME207","name":"Manufacturing Technology Lab","credits":1}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
                "AIML": {"name":"AI & Machine Learning","color":"var(--aiml-color)","icon":"fas fa-brain","semesters":{"1":[{"code":"U23EG107","name":"Engineering Graphics","credits":3},{"code":"U23ENG101A","name":"Communication Skills in English","credits":3},{"code":"U23MAT102A","name":"Linear Algebra and Calculus with MATLAB","credits":4},{"code":"U23PPR105","name":"Problem Solving using Python Programming","credits":3},{"code":"U23PHY103E","name":"Engineering Physics","credits":3},{"code":"U23PHL110","name":"Engineering Physics Laboratory","credits":1},{"code":"U23PPL112","name":"Python Programming Laboratory","credits":1},{"code":"U23TAM101","name":"Heritage of Tamils","credits":1}],"2":[{"code":"U23ENG201A","name":"Technical English","credits":2},{"code":"U23MAT202D","name":"Discrete Mathematics","credits":4},{"code":"U23BEEE206B","name":"Basics of Electrical and Electronics Engineering","credits":3},{"code":"U23CPR205","name":"Programming in C","credits":3},{"code":"U23CHE204C","name":"Applied Chemistry","credits":2},{"code":"U23EC203","name":"Digital Principles and System Design","credits":3},{"code":"U23CPL212","name":"C Programming Laboratory","credits":1},{"code":"U23CHL211","name":"Chemistry Laboratory","credits":1},{"code":"U23BEEL213B","name":"BEEE Laboratory","credits":1},{"code":"U23TAM201","name":"Tamils And Technology","credits":1}],"3":[{"code":"U23MAT301E","name":"Applied Probability and Statistics-I","credits":4},{"code":"U23CS301","name":"Data Structures","credits":3},{"code":"U23CS302","name":"Computer Architecture","credits":3},{"code":"U23CS303","name":"Object Oriented Programming Using Java","credits":3},{"code":"U23AML301","name":"Data Visualization","credits":3},{"code":"noc25-mg106","name":"NPTEL: Design Thinking - A Primer","credits":1},{"code":"U23CS306","name":"Data Structures Laboratory","credits":1},{"code":"U23CS307","name":"Object Oriented Programming Using Java Laboratory","credits":1},{"code":"U23AML302","name":"Data Visualization Laboratory","credits":1},{"code":"U23GE301","name":"Soft Skills and Aptitude-I","credits":1}],"4":[{"code":"U23MAT401A","name":"Applied Probability and Statistics-II","credits":4},{"code":"U23CS403","name":"Database Management Systems","credits":3},{"code":"U23CS401","name":"Design and Analysis of Algorithms","credits":3},{"code":"U23AML401","name":"Artificial Intelligence","credits":3},{"code":"U23CSD402","name":"Operating Systems","credits":3},{"code":"U23AML402","name":"Artificial Intelligence Lab","credits":1},{"code":"U23CS405","name":"Database Management Systems Lab","credits":1},{"code":"U23GE401","name":"Soft Skills and Aptitude-II","credits":1}],"5":[{"code":"U23CS504","name":"Machine Learning","credits":3},{"code":"U23CS501","name":"Computer Networks","credits":3},{"code":"U23CSD502","name":"Software Engineering","credits":3},{"code":"U23CS503","name":"Theory of Computation","credits":3},{"code":"noc25-cs135","name":"Elective NPTEL","credits":3},{"code":"U19CS903","name":"Professional Elective - Agile Methodologies","credits":3},{"code":"U23AML501","name":"Machine Learning Laboratory","credits":2},{"code":"U23CSD504","name":"Software Development Laboratory","credits":1},{"code":"U23GE501","name":"Soft Skills and Aptitude -III","credits":1}],"6":[{"code":"U23CS601","name":"Computer Vision","credits":3},{"code":"U23CS602","name":"Reinforcement Learning","credits":3},{"code":"U23CS603","name":"Robotics","credits":3},{"code":"U23CS604","name":"Cyber Security","credits":3},{"code":"U23CS605","name":"Blockchain Technology","credits":3},{"code":"U23CS606","name":"Elective III","credits":3},{"code":"U23CS607","name":"Project Work II","credits":3}],"7":[{"code":"U23CS701","name":"Advanced Machine Learning","credits":3},{"code":"U23CS702","name":"AI Ethics and Governance","credits":3},{"code":"U23CS703","name":"Elective IV","credits":3},{"code":"U23CS704","name":"Project Work III","credits":3}],"8":[{"code":"U23CS801","name":"Industry Internship","credits":6},{"code":"U23CS802","name":"Project Work IV","credits":6}]}},
                "CIVIL": {"name":"Civil Engineering","color":"var(--civil-color)","icon":"fas fa-building","semesters":{"1":[{"code":"U23CE101","name":"Engineering Mechanics","credits":4},{"code":"U23CE102","name":"Engineering Graphics","credits":4},{"code":"U23CE103","name":"Engineering Mathematics","credits":4},{"code":"U23CE104","name":"Basic Civil Engineering","credits":3},{"code":"U23CE105","name":"Communication Skills","credits":2},{"code":"U23CE106","name":"Surveying","credits":1},{"code":"U23CE107","name":"Engineering Graphics Lab","credits":1}],"2":[{"code":"U23CE201","name":"Building Materials","credits":4},{"code":"U23CE202","name":"Structural Analysis","credits":4},{"code":"U23CE203","name":"Fluid Mechanics","credits":3},{"code":"U23CE204","name":"Surveying","credits":3},{"code":"U23CE205","name":"Computer Programming","credits":3},{"code":"U23CE206","name":"Building Materials Lab","credits":1},{"code":"U23CE207","name":"Surveying Lab","credits":1}]}},
                "BME": {"name":"Biomedical Engineering","color":"var(--bme-color)","icon":"fas fa-heartbeat","semesters":{"1":[{"code":"U23BM101","name":"Human Anatomy","credits":4},{"code":"U23BM102","name":"Engineering Mathematics","credits":4},{"code":"U23BM103","name":"Basic Electronics","credits":3},{"code":"U23BM104","name":"Programming in C","credits":3},{"code":"U23BM105","name":"Communication Skills","credits":2},{"code":"U23BM106","name":"Human Anatomy Lab","credits":1},{"code":"U23BM107","name":"Programming Lab","credits":1}],"2":[{"code":"U23BM201","name":"Human Physiology","credits":4},{"code":"U23BM202","name":"Biochemistry","credits":4},{"code":"U23BM203","name":"Medical Electronics","credits":4},{"code":"U23BM204","name":"Biomechanics","credits":3},{"code":"U23BM205","name":"Data Structures","credits":3},{"code":"U23BM206","name":"Human Physiology Lab","credits":1},{"code":"U23BM207","name":"Medical Electronics Lab","credits":1}]}},
                "FT": {"name":"Fashion Technology","color":"var(--ft-color)","icon":"fas fa-tshirt","semesters":{"1":[{"code":"U23FT101","name":"Fiber Science","credits":4},{"code":"U23FT102","name":"Textile Chemistry","credits":4},{"code":"U23FT103","name":"Fashion Illustration","credits":3},{"code":"U23FT104","name":"Pattern Making","credits":3},{"code":"U23FT105","name":"Communication Skills","credits":2},{"code":"U23FT106","name":"Textile Chemistry Lab","credits":1},{"code":"U23FT107","name":"Pattern Making Lab","credits":1}],"2":[{"code":"U23FT201","name":"Textile Processing","credits":4},{"code":"U23FT202","name":"Apparel Manufacturing","credits":4},{"code":"U23FT203","name":"Fashion Design","credits":4},{"code":"U23FT204","name":"Garment Construction","credits":3},{"code":"U23FT205","name":"Computer Applications","credits":3},{"code":"U23FT206","name":"Apparel Manufacturing Lab","credits":1},{"code":"U23FT207","name":"Garment Construction Lab","credits":1}]}},
                "MCT": {"name":"Mechatronics","color":"var(--mct-color)","icon":"fas fa-robot","semesters":{"1":[{"code":"U23MT101","name":"Engineering Mechanics","credits":4},{"code":"U23MT102","name":"Engineering Graphics","credits":4},{"code":"U23MT103","name":"Engineering Mathematics","credits":4},{"code":"U23MT104","name":"Basic Electronics","credits":3},{"code":"U23MT105","name":"Communication Skills","credits":2},{"code":"U23MT106","name":"Workshop Practice","credits":1},{"code":"U23MT107","name":"Engineering Graphics Lab","credits":1}],"2":[{"code":"U23MT201","name":"Thermodynamics","credits":4},{"code":"U23MT202","name":"Mechanics of Materials","credits":4},{"code":"U23MT203","name":"Digital Electronics","credits":4},{"code":"U23MT204","name":"Fluid Mechanics","credits":3},{"code":"U23MT205","name":"Computer Programming","credits":3},{"code":"U23MT206","name":"Thermodynamics Lab","credits":1},{"code":"U23MT207","name":"Digital Electronics Lab","credits":1}]}},
                "CSD": {"name":"Computer Science & Design","color":"var(--csd-color)","icon":"fas fa-paint-brush","semesters":{"1":[{"code":"U23CD101","name":"Design Fundamentals","credits":4},{"code":"U23CD102","name":"Programming Basics","credits":4},{"code":"U23CD103","name":"Visual Communication","credits":3},{"code":"U23CD104","name":"Mathematics for Design","credits":3},{"code":"U23CD105","name":"Communication Skills","credits":2},{"code":"U23CD106","name":"Design Studio","credits":1},{"code":"U23CD107","name":"Programming Lab","credits":1}],"2":[{"code":"U23CD201","name":"User Interface Design","credits":4},{"code":"U23CD202","name":"Data Structures","credits":4},{"code":"U23CD203","name":"Web Design","credits":4},{"code":"U23CD204","name":"Digital Illustration","credits":3},{"code":"U23CD205","name":"Human-Computer Interaction","credits":3},{"code":"U23CD206","name":"UI Design Lab","credits":1},{"code":"U23CD207","name":"Web Design Lab","credits":1}]}},
                "ADS": {"name":"AI & Data Science","color":"var(--ads-color)","icon":"fas fa-database","semesters":{"1":[{"code":"U23DS101","name":"Programming Fundamentals","credits":4},{"code":"U23DS102","name":"Linear Algebra","credits":4},{"code":"U23DS103","name":"Statistics Basics","credits":3},{"code":"U23DS104","name":"Computational Thinking","credits":3},{"code":"U23DS105","name":"Communication Skills","credits":2},{"code":"U23DS106","name":"Programming Lab","credits":1},{"code":"U23DS107","name":"Statistics Lab","credits":1}],"2":[{"code":"U23DS201","name":"Data Structures","credits":4},{"code":"U23DS202","name":"Probability and Statistics","credits":4},{"code":"U23DS203","name":"Database Systems","credits":4},{"code":"U23DS204","name":"Data Visualization","credits":3},{"code":"U23DS205","name":"Python Programming","credits":3},{"code":"U23DS206","name":"Data Structures Lab","credits":1},{"code":"U23DS207","name":"Database Lab","credits":1}]}},
                "EFE": {"name":"Electrical & Computer Engineering","color":"var(--efe-color)","icon":"fas fa-microchip","semesters":{"1":[{"code":"U23EF101","name":"Circuit Theory","credits":4},{"code":"U23EF102","name":"Programming Fundamentals","credits":4},{"code":"U23EF103","name":"Digital Electronics","credits":3},{"code":"U23EF104","name":"Engineering Mathematics","credits":3},{"code":"U23EF105","name":"Communication Skills","credits":2},{"code":"U23EF106","name":"Circuit Theory Lab","credits":1},{"code":"U23EF107","name":"Programming Lab","credits":1}],"2":[{"code":"U23EF201","name":"Signals and Systems","credits":4},{"code":"U23EF202","name":"Data Structures","credits":4},{"code":"U23EF203","name":"Analog Electronics","credits":4},{"code":"U23EF204","name":"Electromagnetic Theory","credits":3},{"code":"U23EF205","name":"Computer Organization","credits":3},{"code":"U23EF206","name":"Analog Electronics Lab","credits":1},{"code":"U23EF207","name":"Data Structures Lab","credits":1}]}},
                "EXE": {"name":"Electronics & Computer Engineering","color":"var(--exe-color)","icon":"fas fa-desktop","semesters":{"1":[{"code":"U23EX101","name":"Basic Electronics","credits":4},{"code":"U23EX102","name":"Programming Fundamentals","credits":4},{"code":"U23EX103","name":"Digital Logic Design","credits":3},{"code":"U23EX104","name":"Engineering Mathematics","credits":3},{"code":"U23EX105","name":"Communication Skills","credits":2},{"code":"U23EX106","name":"Electronics Lab","credits":1},{"code":"U23EX107","name":"Programming Lab","credits":1}],"2":[{"code":"U23EX201","name":"Data Structures","credits":4},{"code":"U23EX202","name":"Analog Electronics","credits":4},{"code":"U23EX203","name":"Computer Organization","credits":4},{"code":"U23EX204","name":"Signals and Systems","credits":3},{"code":"U23EX205","name":"Database Systems","credits":3},{"code":"U23EX206","name":"Analog Electronics Lab","credits":1},{"code":"U23EX207","name":"Data Structures Lab","credits":1}]}}
            }
        };
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDCmvA9sFCSc5r4ZuFUJuGdO1LDoW7rKao",
            authDomain: "student-portal-free.firebaseapp.com",
            projectId: "student-portal-free",
            storageBucket: "student-portal-free.appspot.com",
            messagingSenderId: "272865877510",
            appId: "1:272865877510:web:0875a2502ae55bbf9ead87"
        };
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showToast("Failed to initialize application. Please refresh the page.", "error");
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let materials = [];
        let filteredMaterials = [];
        let downloadedMaterials = [];
        let tempSelectedBranch = null;
        let tempSelectedSemester = null;
        let tempSelectedCourse = null;

        // --- DOM ELEMENT VARIABLES ---
        let themeToggle, themeIcon, accountBtn, accountMenu, accountAvatar, accountName, 
            accountEmail, accountFullName, accountEmailDetail, accountMemberSince, 
            accountDownloads, accountLogout, materialsGrid, materialsCount, branchFilter, 
            semesterFilter, courseFilter, typeFilter, searchFilter, resetFilters, 
            advancedFilterBtn, downloadedMaterialsList, chatbotToggle, chatbotContainer, 
            chatbotMessages, chatbotInput, chatbotSend, chatbotClose, chatbotReset, toast, toastMessage, 
            editProfileBtn, profileEditForm, displayNameInput, saveProfileBtn, cancelEditBtn, 
            preferencesBtn, privacyBtn, helpBtn, branchSemesterCourseModal, selectionModalClose, 
            prevStepBtn, nextStepBtn, finishSelectionBtn, branchStep, semesterStep, courseStep, 
            branchOptions, semesterOptions, courseOptions, stepIndicators, selectionDisplay, 
            selectedBranchDisplay, selectedSemesterDisplay, selectedCourseDisplay, changeSelectionBtn;
        
        // --- FUNCTIONS ---
        
        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            themeToggle.addEventListener('click', toggleTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        // Toast Notifications
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            const icon = toast.querySelector('.toast-icon');
            icon.className = `toast-icon fas ${
                type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                'fa-info-circle'
            }`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Filter Logic
        function initFilters() {
            typeFilter.addEventListener('change', applyFilters);
            searchFilter.addEventListener('input', applyFilters);
            resetFilters.addEventListener('click', resetAllFilters);
            advancedFilterBtn.addEventListener('click', () => {
                resetSelectionModal();
                branchSemesterCourseModal.classList.add('active');
            });
        }
        
        function applyFilters() {
            const branch = branchFilter.value;
            const semester = semesterFilter.value;
            const course = courseFilter.value;
            const type = typeFilter.value;
            const search = searchFilter.value.toLowerCase();
            
            filteredMaterials = materials.filter(material => {
                const matchesBranch = !branch || material.branch === branch;
                const matchesSemester = !semester || material.semester === semester;
                const matchesCourse = !course || (material.courseCode && material.courseCode === course);
                const matchesType = !type || material.type === type;
                const matchesSearch = !search || 
                                      (material.title && material.title.toLowerCase().includes(search)) || 
                                      (material.description && material.description.toLowerCase().includes(search));
                return matchesBranch && matchesSemester && matchesCourse && matchesType && matchesSearch;
            });
            renderMaterials();
        }
        
        function resetAllFilters() {
            branchFilter.value = '';
            semesterFilter.value = '';
            courseFilter.innerHTML = '';
            typeFilter.value = '';
            searchFilter.value = '';
            selectionDisplay.style.display = 'none';
            applyFilters();
            showToast('Filters have been reset', 'info');
        }
        
        // Material Loading & Rendering
        function loadMaterials() {
            if (!currentUser) return;
            materialsGrid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            db.collection('materials').orderBy('createdAt', 'desc').get().then(snapshot => {
                materials = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredMaterials = [...materials];
                renderMaterials();
                loadDownloadedMaterials();
            }).catch(error => {
                console.error('Error loading materials:', error);
                showToast("Error loading materials.", 'error');
                materialsGrid.innerHTML = `<div class="empty-state"><div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div><h3 class="empty-title">Error Loading Materials</h3></div>`;
            });
        }

        function renderMaterials() {
            materialsCount.textContent = `Showing ${filteredMaterials.length} of ${materials.length} materials`;
            if (filteredMaterials.length === 0) {
                materialsGrid.innerHTML = `<div class="empty-state"><div class="empty-icon"><i class="fas fa-folder-open"></i></div><h3 class="empty-title">No Materials Found</h3><p class="empty-description">Try adjusting your filters or check back later</p></div>`;
                return;
            }
            materialsGrid.innerHTML = filteredMaterials.map(material => {
                const branch = academicData.branches[material.branch];
                const branchColor = branch ? branch.color : 'var(--primary)';
                return `
                    <div class="material-card" data-id="${material.id}">
                        <div class="material-thumbnail">
                            ${material.thumbnail ? `<img src="${material.thumbnail}" alt="${material.title}">` : `<i class="fas ${getMaterialIcon(material.type || 'notes')}"></i>`}
                            <div class="material-type-badge">${material.type || 'Notes'}</div>
                        </div>
                        <div class="material-content">
                            <h3 class="material-title">${material.title}</h3>
                            <p class="material-description">${material.description}</p>
                            <div class="material-meta">
                                <div class="material-branch">
                                    <div class="material-branch-color" style="background-color: ${branchColor}"></div>
                                    <span>${branch ? branch.name : material.branch}</span>
                                </div>
                                <span>Semester ${material.semester}</span>
                            </div>
                            <div class="material-actions">
                                <button class="material-action view" title="View"><i class="fas fa-eye"></i></button>
                                <button class="material-action download" title="Download"><i class="fas fa-download"></i></button>
                                <button class="material-action favorite" title="Favorite"><i class="fas fa-star"></i></button>
                                <button class="material-action share" title="Share"><i class="fas fa-share"></i></button>
                                <button class="material-action report" title="Report"><i class="fas fa-flag"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            materialsGrid.querySelectorAll('.material-action').forEach(btn => btn.addEventListener('click', handleMaterialAction));
        }
        
        function loadDownloadedMaterials() {
            if (!currentUser) return;
            downloadedMaterialsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            db.collection('userActivities').where('userId', '==', currentUser.uid).where('action', '==', 'download').get().then(snapshot => {
                const uniqueMaterialIds = [...new Set(snapshot.docs.map(doc => doc.data().materialId))];
                accountDownloads.textContent = uniqueMaterialIds.length;
                renderDownloadedMaterials(uniqueMaterialIds);
            }).catch(error => {
                console.error('Error loading downloaded materials:', error);
                downloadedMaterialsList.innerHTML = `<div class="empty-state"><p class="empty-description">Error loading downloads</p></div>`;
            });
        }

        function renderDownloadedMaterials(materialIds) {
            if (materialIds.length === 0) {
                downloadedMaterialsList.innerHTML = `<div class="empty-state"><div class="empty-icon"><i class="fas fa-download"></i></div><p class="empty-description">No downloaded materials yet</p></div>`;
                return;
            }
            const materialPromises = materialIds.map(id => db.collection('materials').doc(id).get());
            Promise.all(materialPromises).then(snapshots => {
                const materialsData = snapshots.filter(s => s.exists).map(s => ({ id: s.id, ...s.data() }));
                downloadedMaterialsList.innerHTML = materialsData.map(material => {
                    const branch = academicData.branches[material.branch];
                    const branchColor = branch ? branch.color : 'var(--primary)';
                    return `
                        <div class="account-item" data-id="${material.id}">
                            <div class="account-item-icon" style="background-color: ${branchColor}20; color: ${branchColor}">
                                <i class="fas ${getMaterialIcon(material.type)}"></i>
                            </div>
                            <div class="account-item-info">
                                <div class="account-item-title">${material.title}</div>
                                <div class="account-item-meta">${material.type}  ${branch ? branch.name : material.branch}</div>
                            </div>
                        </div>`;
                }).join('');
                downloadedMaterialsList.querySelectorAll('.account-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const material = materials.find(m => m.id === item.dataset.id);
                        if (material) viewMaterial(material);
                        accountMenu.classList.remove('active');
                    });
                });
            });
        }

        function getMaterialIcon(type) {
            const icons = { 'notes': 'fa-file-alt', 'ebook': 'fa-book', 'slides': 'fa-presentation', 'video': 'fa-video', 'lab': 'fa-flask', 'project': 'fa-project-diagram' };
            return icons[type] || 'fa-file';
        }
        
        // Material Actions
        function handleMaterialAction(e) {
            e.stopPropagation();
            const action = e.currentTarget.classList[1];
            const materialCard = e.currentTarget.closest('.material-card');
            const materialId = materialCard.dataset.id;
            const material = materials.find(m => m.id === materialId);
            if (!material) return;
            switch (action) {
                case 'view': viewMaterial(material); break;
                case 'download': downloadMaterial(material); break;
                case 'favorite': toggleFavorite(material, e.currentTarget); break;
                case 'share': shareMaterial(material); break;
                case 'report': reportMaterial(material); break;
            }
        }
        
        function viewMaterial(material) {
            if (material.link) window.open(material.link, '_blank');
            else showToast('Material file not available', 'error');
        }
        
        function downloadMaterial(material) {
            if (material.link) {
                const a = document.createElement('a');
                a.href = material.link;
                a.target = "_blank";
                document.body.appendChild(a);
                a.click();
                a.remove();
                showToast('Opening download link...', 'success');
                if (currentUser) {
                    db.collection('userActivities').add({
                        userId: currentUser.uid, action: 'download', materialId: material.id,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(loadDownloadedMaterials);
                }
            } else showToast('Material file not available', 'error');
        }
        
        function toggleFavorite(material, btn) { /* ... implementation ... */ }
        function shareMaterial(material) { /* ... implementation ... */ }
        function reportMaterial(material) { /* ... implementation ... */ }
        
        // Course Selection Modal Logic
        function initBranchSemesterCourseModal() {
            initializeBranchOptions();
            selectionModalClose.addEventListener('click', () => branchSemesterCourseModal.classList.remove('active'));
            prevStepBtn.addEventListener('click', goToPrevStep);
            nextStepBtn.addEventListener('click', goToNextStep);
            finishSelectionBtn.addEventListener('click', finishSelection);
            changeSelectionBtn.addEventListener('click', () => {
                resetSelectionModal();
                branchSemesterCourseModal.classList.add('active');
            });
        }
        function resetSelectionModal() {
            tempSelectedBranch = null; tempSelectedSemester = null; tempSelectedCourse = null;
            semesterStep.classList.remove('active'); courseStep.classList.remove('active');
            branchStep.classList.add('active');
            stepIndicators[1].classList.remove('active'); stepIndicators[2].classList.remove('active');
            stepIndicators[0].classList.add('active');
            prevStepBtn.style.display = 'none'; finishSelectionBtn.style.display = 'none';
            nextStepBtn.style.display = 'block'; nextStepBtn.disabled = true;
            document.querySelectorAll('.selection-card.selected').forEach(c => c.classList.remove('selected'));
        }
        function initializeBranchOptions() {
            branchOptions.innerHTML = Object.keys(academicData.branches).map(code => {
                const branch = academicData.branches[code];
                return `<div class="selection-card" data-branch="${code}"><div class="selection-icon"><i class="${branch.icon}"></i></div><div class="selection-name">${branch.name}</div><div class="selection-code">${code}</div></div>`;
            }).join('');
            branchOptions.querySelectorAll('.selection-card').forEach(c => c.addEventListener('click', () => selectBranch(c.dataset.branch)));
        }
        function selectBranch(code) {
            tempSelectedBranch = code;
            branchOptions.querySelectorAll('.selection-card').forEach(c => c.classList.toggle('selected', c.dataset.branch === code));
            nextStepBtn.disabled = false;
        }
        function initializeSemesterOptions() {
            const semesters = academicData.branches[tempSelectedBranch]?.semesters;
            semesterOptions.innerHTML = Object.keys(semesters).filter(semNum => semesters[semNum].length > 0).map(semNum => {
                return `<div class="selection-card" data-semester="${semNum}"><div class="selection-icon"><i class="fas fa-calendar-alt"></i></div><div class="selection-name">Semester ${semNum}</div></div>`;
            }).join('');
            semesterOptions.querySelectorAll('.selection-card').forEach(c => c.addEventListener('click', () => selectSemester(c.dataset.semester)));
        }
        function selectSemester(semNum) {
            tempSelectedSemester = semNum;
            semesterOptions.querySelectorAll('.selection-card').forEach(c => c.classList.toggle('selected', c.dataset.semester === semNum));
            nextStepBtn.disabled = false;
        }
        function initializeCourseOptions() {
            const courses = academicData.branches[tempSelectedBranch]?.semesters[tempSelectedSemester] || [];
            courseOptions.innerHTML = courses.map(course => {
                return `<div class="selection-card" data-course='${JSON.stringify(course)}'><div class="selection-name">${course.name}</div><div class="selection-code">${course.code}</div><div class="selection-code">${course.credits} Credits</div></div>`;
            }).join('');
            courseOptions.querySelectorAll('.selection-card').forEach(c => c.addEventListener('click', () => selectCourse(JSON.parse(c.dataset.course))));
        }
        function selectCourse(course) {
            tempSelectedCourse = course;
            courseOptions.querySelectorAll('.selection-card').forEach(c => c.classList.toggle('selected', JSON.parse(c.dataset.course).code === course.code));
            finishSelectionBtn.disabled = false;
        }
        function goToNextStep() {
            const currentStep = document.querySelector('.selection-step.active');
            if (currentStep.id === 'branch-step') {
                if (!tempSelectedBranch) return;
                currentStep.classList.remove('active'); semesterStep.classList.add('active');
                stepIndicators[1].classList.add('active'); initializeSemesterOptions();
                prevStepBtn.style.display = 'block'; nextStepBtn.disabled = true;
            } else if (currentStep.id === 'semester-step') {
                if (!tempSelectedSemester) return;
                currentStep.classList.remove('active'); courseStep.classList.add('active');
                stepIndicators[2].classList.add('active'); initializeCourseOptions();
                nextStepBtn.style.display = 'none'; finishSelectionBtn.style.display = 'block';
                finishSelectionBtn.disabled = true;
            }
        }
        function goToPrevStep() {
            const currentStep = document.querySelector('.selection-step.active');
            if (currentStep.id === 'semester-step') {
                currentStep.classList.remove('active'); branchStep.classList.add('active');
                stepIndicators[1].classList.remove('active'); prevStepBtn.style.display = 'none';
                nextStepBtn.disabled = false;
            } else if (currentStep.id === 'course-step') {
                currentStep.classList.remove('active'); semesterStep.classList.add('active');
                stepIndicators[2].classList.remove('active'); finishSelectionBtn.style.display = 'none';
                nextStepBtn.style.display = 'block'; nextStepBtn.disabled = false;
            }
        }
        function finishSelection() {
            if (!tempSelectedCourse) return;
            selectedBranchDisplay.textContent = academicData.branches[tempSelectedBranch].name;
            selectedSemesterDisplay.textContent = `Semester ${tempSelectedSemester}`;
            selectedCourseDisplay.textContent = tempSelectedCourse.name;
            selectionDisplay.style.display = 'flex';
            branchFilter.value = tempSelectedBranch;
            semesterFilter.value = tempSelectedSemester;
            courseFilter.innerHTML = `<option value="${tempSelectedCourse.code}" selected>${tempSelectedCourse.name}</option>`;
            applyFilters();
            branchSemesterCourseModal.classList.remove('active');
        }
        
        // Chatbot with Vercel Backend
        function initChatbot() {
            // Replace with your Vercel backend URL
            const API_URL = "YOUR_VERCEL_BACKEND_URL/api/chat"; 
            const MAX_HISTORY = 10;
            let chatHistory = [];
        
            function addMessage(text, sender, isLoading = false) {
                const messageRow = document.createElement('div');
                messageRow.className = `message-row ${sender}`;
                
                if (sender === 'bot') {
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'bot-avatar';
                    avatarDiv.textContent = 'IB';
                    messageRow.appendChild(avatarDiv);
                }
        
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
        
                if (isLoading) {
                    messageDiv.innerHTML = `<div class="spinner"></div>`; 
                    messageDiv.classList.add('loading');
                } else {
                    const parsedText = parseResponseForCodeBlocks(text);
                    messageDiv.innerHTML = parsedText;
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
        
                messageRow.appendChild(messageDiv);
                chatbotMessages.appendChild(messageRow);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                return messageDiv;
            }
        
            function parseResponseForCodeBlocks(text) {
                const codeBlockRegex = /```(.*?)```/gs;
                let lastIndex = 0;
                let result = '';
                let match;
                
                while ((match = codeBlockRegex.exec(text)) !== null) {
                    result += text.substring(lastIndex, match.index).replace(/\n/g, '<br>');
                    
                    const codeContent = match[1].trim();
                    let lang = '';
                    const firstLineEnd = codeContent.indexOf('\n');
                    if (firstLineEnd !== -1) {
                        lang = codeContent.substring(0, firstLineEnd).trim();
                        if (lang.length > 0) {
                            const actualCode = codeContent.substring(firstLineEnd).trim();
                            result += `<div class="code-block"><pre><code class="language-${lang}">${actualCode}</code></pre></div>`;
                        } else {
                            result += `<div class="code-block"><pre><code>${codeContent}</code></pre></div>`;
                        }
                    } else {
                        result += `<div class="code-block"><pre><code>${codeContent}</code></pre></div>`;
                    }
                    
                    lastIndex = codeBlockRegex.lastIndex;
                }
                
                result += text.substring(lastIndex).replace(/\n/g, '<br>');
                
                return result;
            }

            // Function to stream the response text
            async function streamResponse(element, response) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
            
                // Create a temporary span for the typewriter effect
                const tempSpan = document.createElement('span');
                element.appendChild(tempSpan);
                tempSpan.classList.add('typing');
            
                // Function to type out a chunk of text
                const typeChunk = (chunk) => {
                    return new Promise(resolve => {
                        let i = 0;
                        const speed = 15;
                        function type() {
                            if (i < chunk.length) {
                                tempSpan.textContent += chunk.charAt(i);
                                i++;
                                setTimeout(type, speed);
                            } else {
                                resolve();
                            }
                        }
                        type();
                    });
                };
            
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    
                    // Add the chunk to the full text
                    fullText += chunk;
                    
                    // Remove the current content and typewriter span
                    element.innerHTML = '';
                    
                    // Process the full text and add it back
                    const parsed = parseResponseForCodeBlocks(fullText);
                    element.innerHTML = parsed;
            
                    // Re-append the typing span and apply effects
                    element.querySelector('.code-block:last-child pre code:last-child')?.appendChild(tempSpan);
                    if (!element.querySelector('.code-block:last-child')) {
                        element.appendChild(tempSpan);
                    }
            
                    // Re-highlight the code blocks
                    element.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                    });
                    
                    await typeChunk(chunk); // Animate the typing for the new chunk
                    
                    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                }
            
                // Final clean up and highlight
                tempSpan.classList.remove('typing');
                element.innerHTML = parseResponseForCodeBlocks(fullText);
                element.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });

                // Update chat history with the final, complete message
                chatHistory.push({ role: "assistant", content: fullText.trim() });
                if (chatHistory.length > MAX_HISTORY) {
                    chatHistory = chatHistory.slice(chatHistory.length - MAX_HISTORY);
                }
            }

            function initializeChat() {
                chatbotMessages.innerHTML = '';
                chatHistory = [{ role: "assistant", content: "Hello! I'm IB, your AI study assistant. I was created by AJ COMPANY. How can I help you today?" }];
                addMessage(chatHistory[0].content, 'bot');
            }
        
            async function sendMessage() {
                const message = chatbotInput.value.trim();
                if (!message) return;
        
                chatbotInput.disabled = true;
                chatbotSend.disabled = true;
        
                addMessage(message, 'user');
                chatHistory.push({ role: "user", content: message });
                chatbotInput.value = '';
                
                const loadingEl = addMessage('', 'bot', true);
        
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ai: "gemini",
                            history: chatHistory
                        })
                    });
        
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `API error: ${response.status}`);
                    }
                    
                    loadingEl.remove();
                    
                    // Stream the response directly to the message element
                    const messageEl = addMessage('', 'bot');
                    await streamResponse(messageEl, response);

                } catch (error) {
                    console.error('Chatbot error:', error);
                    loadingEl.remove();
                    addMessage(`Error: ${error.message}. Please try again.`, 'bot');
                } finally {
                    chatbotInput.disabled = false;
                    chatbotSend.disabled = false;
                    chatbotInput.focus();
                }
            }
        
            chatbotToggle.addEventListener('click', () => chatbotContainer.classList.toggle('active'));
            chatbotClose.addEventListener('click', () => chatbotContainer.classList.remove('active'));
            chatbotReset.addEventListener('click', initializeChat);
            chatbotSend.addEventListener('click', sendMessage);
            chatbotInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
            
            initializeChat();
        }

        // Account Management
        function initAccount() {
            accountBtn.addEventListener('click', () => accountMenu.classList.toggle('active'));
            accountLogout.addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    auth.signOut().then(() => {
                        showToast('Logged out successfully', 'success');
                        window.location.href = '/index.html';
                    });
                }
            });
            document.addEventListener('click', (e) => {
                if (!accountBtn.contains(e.target) && !accountMenu.contains(e.target) && !e.target.closest('.account-menu')) {
                    accountMenu.classList.remove('active');
                }
            });
        }
        
        // Authentication
        function initAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    accountName.textContent = user.displayName || user.email.split('@')[0];
                    accountEmail.textContent = user.email;
                    accountFullName.textContent = user.displayName || 'Not set';
                    accountEmailDetail.textContent = user.email;
                    if (user.metadata.creationTime) {
                        accountMemberSince.textContent = new Date(user.metadata.creationTime).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    }
                    accountAvatar.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="Profile">` : `<i class="fas fa-user"></i>`;
                    loadMaterials();
                } else {
                    showToast("Please log in to access materials", "info");
                    setTimeout(() => { window.location.href = '/index.html'; }, 2000);
                }
            });
        }
        
        // --- APPLICATION INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // First, cache all DOM elements now that the document is ready.
            themeToggle = document.getElementById('themeToggle');
            themeIcon = document.getElementById('themeIcon');
            accountBtn = document.getElementById('accountBtn');
            accountMenu = document.getElementById('accountMenu');
            accountAvatar = document.getElementById('accountAvatar');
            accountName = document.getElementById('accountName');
            accountEmail = document.getElementById('accountEmail');
            accountFullName = document.getElementById('accountFullName');
            accountEmailDetail = document.getElementById('accountEmailDetail');
            accountMemberSince = document.getElementById('accountMemberSince');
            accountDownloads = document.getElementById('accountDownloads');
            accountLogout = document.getElementById('accountLogout');
            materialsGrid = document.getElementById('materialsGrid');
            materialsCount = document.getElementById('materialsCount');
            branchFilter = document.getElementById('branchFilter');
            semesterFilter = document.getElementById('semesterFilter');
            courseFilter = document.getElementById('courseFilter');
            typeFilter = document.getElementById('typeFilter');
            searchFilter = document.getElementById('searchFilter');
            resetFilters = document.getElementById('resetFilters');
            advancedFilterBtn = document.getElementById('advancedFilterBtn');
            downloadedMaterialsList = document.getElementById('downloadedMaterials');
            chatbotToggle = document.getElementById('chatbotToggle');
            chatbotContainer = document.getElementById('chatbotContainer');
            chatbotMessages = document.getElementById('chatbotMessages');
            chatbotInput = document.getElementById('chatbotInput');
            chatbotSend = document.getElementById('chatbotSend');
            chatbotClose = document.getElementById('chatbotClose');
            chatbotReset = document.getElementById('chatbotReset');
            toast = document.getElementById('toast');
            toastMessage = document.getElementById('toastMessage');
            editProfileBtn = document.getElementById('editProfileBtn');
            profileEditForm = document.getElementById('profileEditForm');
            displayNameInput = document.getElementById('displayNameInput');
            saveProfileBtn = document.getElementById('saveProfileBtn');
            cancelEditBtn = document.getElementById('cancelEditBtn');
            preferencesBtn = document.getElementById('preferencesBtn');
            privacyBtn = document.getElementById('privacyBtn');
            helpBtn = document.getElementById('helpBtn');
            branchSemesterCourseModal = document.getElementById('branch-semester-course-modal');
            selectionModalClose = document.getElementById('selection-modal-close');
            prevStepBtn = document.getElementById('prev-step-btn');
            nextStepBtn = document.getElementById('next-step-btn');
            finishSelectionBtn = document.getElementById('finish-selection-btn');
            branchStep = document.getElementById('branch-step');
            semesterStep = document.getElementById('semester-step');
            courseStep = document.getElementById('course-step');
            branchOptions = document.getElementById('branch-options');
            semesterOptions = document.getElementById('semester-options');
            courseOptions = document.getElementById('course-options');
            stepIndicators = document.querySelectorAll('.step');
            selectionDisplay = document.getElementById('selection-display');
            selectedBranchDisplay = document.getElementById('selected-branch');
            selectedSemesterDisplay = document.getElementById('selected-semester');
            selectedCourseDisplay = document.getElementById('selected-course');
            changeSelectionBtn = document.getElementById('change-selection');

            // Then, initialize all the application modules.
            initTheme();
            initAuth();
            initFilters();
            initChatbot();
            initAccount();
            initBranchSemesterCourseModal();
        });
    </script>
</body>
</html>

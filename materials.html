<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Materials | IB STUDIOZ</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23FFD700' d='M50,2 A48,48 0 1,0 50,98 A48,48 0 1,0 50,2 Z' /%3E%3Cg fill='%230A0A0A'%3E%3Cpath d='M28,25 h10 v50 h-10 Z' /%3E%3Cpath d='M45,25 H60 A12.5,12.5 0 0,1 60,50 H45 Z M45,50 H63 A12.5,12.5 0 0,1 63,75 H45 Z' /%3E%3C/g%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base, Background, Header, Page Title Styles --- */
        :root {
            --primary-glow: #FFD700; --secondary-glow: #00A2FF; --dark-bg: #0A0A0A;
            --text-primary: #F0F0F0; --text-secondary: #A0A0A0; --card-bg: rgba(22, 22, 22, 0.8);
            --border-color: rgba(255, 215, 0, 0.2); --shadow-color: rgba(0, 0, 0, 0.5);
            --primary-glow-transparent: rgba(255, 215, 0, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--dark-bg);
            color: var(--text-primary); line-height: 1.6;
            opacity: 0; animation: page-fade-in 0.4s ease-out forwards;
        }
        @keyframes page-fade-in { to { opacity: 1; } }
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
        .aurora-layer { /* ...aurora styles... */ }
        @keyframes aurora-morph { /* ...aurora keyframes... */ }
        .noise-layer { /* ...noise styles... */ }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page-header { /* ...header styles... */ }
        .brand-logo { /* ...brand styles... */ }
        .header-logo-svg { /* ...logo styles... */ }
        .brand-title { /* ...title styles... */ }
        .brand-title::before { /* ...title glow styles... */ }
        @keyframes rgb-text-flow { /* ...title animation... */ }
        .btn, .btn-secondary { /* ...button styles... */ }
        .btn-secondary:hover { /* ...button hover styles... */ }
        .btn-secondary .fas { /* ...button icon styles... */ }
        .btn-primary { /* ...primary button styles... */ }
        .btn-primary:hover { /* ...primary button hover styles... */ }
        .page-title-header { /* ...page title styles... */ }
        .page-title-header h1 { /* ...h1 styles... */ }
        .page-title-header p { /* ...p styles... */ }
        
        /* --- FINAL COMBINED CARD STYLES --- */
        .materials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        
        .material-card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 15px; overflow: hidden; /* Important for the image */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; flex-direction: column;
            cursor: pointer;
        }
        .material-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 25px var(--primary-glow-transparent);
        }
        
        /* This is the new thumbnail container */
        .card-thumbnail {
            width: 100%;
            height: 180px; /* Adjust height as needed */
            overflow: hidden;
        }
        .card-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures the image covers the area without distortion */
            display: block;
            background-color: #333;
        }

        /* This container holds your original card content */
        .card-content-wrapper {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .material-title { font-size: 1.3rem; margin-bottom: 8px; color: var(--text-primary); }
        .material-meta { font-size: 0.9rem; color: var(--text-secondary); }
        .material-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; /* Pushes footer to the bottom */ padding-top: 20px; border-top: 1px solid var(--border-color); }
        .tag { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .tag-free { background-color: rgba(16, 185, 129, 0.2); color: #10B981; }
        .tag-premium { background-color: rgba(255, 179, 71, 0.2); color: #ffb347; }
        .material-action-icon { font-size: 1.5rem; color: var(--text-secondary); }
        .material-card:hover .material-action-icon { color: var(--primary-glow); }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 50px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color); }
        .empty-state i { font-size: 3rem; color: var(--primary-glow); margin-bottom: 20px; display: block; }

        /* --- Modal (Popup) Styling --- */
        .modal-overlay { /* ...modal styles... */ }
        .modal-overlay.active { /* ...modal active styles... */ }
        .modal-content { /* ...modal content styles... */ }
        .modal-overlay.active .modal-content { /* ...modal animation styles... */ }
        .modal-close { /* ...modal close button styles... */ }
        .modal-header { /* ...modal header styles... */ }
        #modal-title { /* ...modal title styles... */ }
        #modal-courseCode, #modal-description { /* ...modal text styles... */ }
        #modal-description { /* ...modal description styles... */ }
        .modal-body { /* ...modal body styles... */ }
        #modal-embed-preview { /* ...iframe styles... */ }
    </style>
</head>
<body>
    <div class="background-container"><!-- Background elements --></div>

    <main>
        <header class="page-header"><!-- Header content --></header>
        <div class="container">
            <div class="page-title-header"><!-- Page Title content --></div>
            <div id="materials-grid" class="materials-grid">
                <!-- Skeletons or material cards will be injected here by JS -->
            </div>
        </div>
    </main>

    <!-- MODAL FOR DETAILS VIEW -->
    <div id="details-modal" class="modal-overlay"><!-- Modal content --></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('materials-grid');
            const modal = document.getElementById('details-modal');
            const closeBtn = document.getElementById('modal-close-btn');
            const firebaseConfig = { /* Your Config */ };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            auth.onAuthStateChanged(user => user ? loadMaterials() : window.location.replace('/index.html'));
            
            function showSkeletonLoader() { /* Your skeleton code is fine */ }
            function getGoogleDriveEmbedUrl(shareUrl) { /* Function is fine */ }

            async function loadMaterials() {
                // showSkeletonLoader();
                try {
                    const snapshot = await db.collection('materials').orderBy('uploadedAt', 'desc').get();
                    if (snapshot.empty) {
                        grid.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><p>No materials yet.</p></div>`;
                        return;
                    }

                    grid.innerHTML = '';
                    snapshot.forEach(doc => {
                        const material = doc.data();
                        const card = document.createElement('div');
                        card.className = 'material-card';

                        // Store data in dataset for the modal
                        card.dataset.title = material.title || 'No Title';
                        card.dataset.courseCode = material.courseCode || 'N/A';
                        card.dataset.description = material.description || 'No description available.';
                        card.dataset.downloadUrl = material.downloadURL;
                        card.dataset.embedUrl = getGoogleDriveEmbedUrl(material.downloadURL);
                        card.dataset.isPaid = material.isPaid || false;
                        
                        const isPremium = material.isPaid || false;
                        const placeholderImg = 'https://via.placeholder.com/400x200.png?text=Preview+Unavailable';
                        const thumbnailSrc = (material.thumbnailURL && material.thumbnailURL.trim() !== '') ? material.thumbnailURL : placeholderImg;

                        // This is the new, combined HTML structure
                        card.innerHTML = `
                            <div class="card-thumbnail">
                                <img src="${thumbnailSrc}" alt="${material.title} preview" onerror="this.onerror=null; this.src='${placeholderImg}';">
                            </div>
                            <div class="card-content-wrapper">
                                <div class="material-info">
                                    <h3 class="material-title">${material.title}</h3>
                                    <p class="material-meta">Course: ${material.courseCode}</p>
                                </div>
                                <div class="material-footer">
                                    <span class="tag ${isPremium ? 'tag-premium' : 'tag-free'}">${isPremium ? 'Premium' : 'Free'}</span>
                                    <i class="fas ${isPremium ? 'fa-lock' : 'fa-eye'} material-action-icon"></i>
                                </div>
                            </div>
                        `;

                        card.addEventListener('click', () => {
                            if (card.dataset.isPaid === 'true') {
                                alert('This is a premium resource! Please contact the admin for access.');
                                return;
                            }
                            
                            // Populate and show the modal
                            document.getElementById('modal-title').textContent = card.dataset.title;
                            document.getElementById('modal-courseCode').textContent = card.dataset.courseCode;
                            document.getElementById('modal-description').textContent = card.dataset.description;
                            document.getElementById('modal-download-btn').href = card.dataset.downloadUrl;
                            document.getElementById('modal-embed-preview').src = card.dataset.embedUrl;
                            modal.classList.add('active');
                        });
                        
                        grid.appendChild(card);
                    });
                } catch (err) {
                    console.error("Error loading materials:", err);
                    grid.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Could not load materials.</p></div>`;
                }
            }
            
            const closeModal = () => { /* closeModal function is fine */ };
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.getElementById('logout-btn').addEventListener('click', (e) => { /* logout function is fine */ });
        });
    </script>
</body>
</html>

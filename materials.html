<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Materials | IB STUDIOZ</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23FFD700' d='M50,2 A48,48 0 1,0 50,98 A48,48 0 1,0 50,2 Z' /%3E%3Cg fill='%230A0A0A'%3E%3Cpath d='M28,25 h10 v50 h-10 Z' /%3E%3Cpath d='M45,25 H60 A12.5,12.5 0 0,1 60,50 H45 Z M45,50 H63 A12.5,12.5 0 0,1 63,75 H45 Z' /%3E%3C/g%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-glow: #FFD700; --secondary-glow: #00A2FF; --dark-bg: #0A0A0A;
            --text-primary: #F0F0F0; --text-secondary: #A0A0A0; --card-bg: rgba(22, 22, 22, 0.8);
            --border-color: rgba(255, 215, 0, 0.2); --shadow-color: rgba(0, 0, 0, 0.5);
            --primary-glow-transparent: rgba(255, 215, 0, 0.15);
            --danger: #e74c3c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--dark-bg);
            color: var(--text-primary); line-height: 1.6;
            opacity: 0;
            animation: page-fade-in 0.4s ease-out forwards;
        }
        @keyframes page-fade-in { 
            to { opacity: 1; } 
        }
        
        .background-container { /* ... (Your existing styles) ... */ }
        .aurora-layer { /* ... (Your existing styles) ... */ }
        @keyframes aurora-morph { /* ... (Your existing styles) ... */ }
        .noise-layer { /* ... (Your existing styles) ... */ }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page-header { /* ... (Your existing styles) ... */ }
        .brand-logo { /* ... (Your existing styles) ... */ }
        .header-logo-svg { /* ... (Your existing styles) ... */ }
        .brand-title { /* ... (Your existing styles) ... */ }
        .brand-title::before { /* ... (Your existing styles) ... */ }
        @keyframes rgb-text-flow { /* ... (Your existing styles) ... */ }
        .btn, .btn-secondary { /* ... (Your existing styles) ... */ }
        .btn-secondary:hover { /* ... (Your existing styles) ... */ }
        .btn-secondary .fas { /* ... (Your existing styles) ... */ }
        .btn-primary { /* ... (Your existing styles) ... */ }
        .btn-primary:hover { /* ... (Your existing styles) ... */ }
        .page-title-header { /* ... (Your existing styles) ... */ }
        .page-title-header h1 { /* ... (Your existing styles) ... */ }
        .page-title-header p { /* ... (Your existing styles) ... */ }
        
        .materials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        
        .material-card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 15px; overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; flex-direction: column;
            position: relative; /* Needed for positioning the delete button */
        }
        .material-card-clickable {
            cursor: pointer;
        }
        .material-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 25px var(--primary-glow-transparent);
        }
        .card-thumbnail {
            width: 100%; height: 180px; overflow: hidden;
            position: relative; /* Also needed for the delete button */
        }
        .card-thumbnail img {
            width: 100%; height: 100%; object-fit: cover; display: block; background-color: #333;
        }
        
        /* --- NEW: Delete Button Styles --- */
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(10, 10, 10, 0.7);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 2; /* Ensures it's on top of the image */
        }
        .delete-btn:hover {
            background: var(--danger);
            color: var(--text-primary);
            border-color: var(--danger);
            transform: scale(1.1);
        }
        /* --- End of New Styles --- */

        .card-content-wrapper { padding: 20px 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .material-info { flex-grow: 1; }
        .material-title { font-size: 1.3rem; margin-bottom: 8px; color: var(--text-primary); }
        .material-meta { font-size: 0.9rem; color: var(--text-secondary); }
        .material-footer { /* ... (Your existing styles) ... */ }
        .tag { /* ... (Your existing styles) ... */ }
        .tag-free { /* ... (Your existing styles) ... */ }
        .tag-premium { /* ... (Your existing styles) ... */ }
        .material-action-icon { /* ... (Your existing styles) ... */ }
        .material-card:hover .material-action-icon { /* ... (Your existing styles) ... */ }
        .empty-state { /* ... (Your existing styles) ... */ }
        .empty-state i { /* ... (Your existing styles) ... */ }
        
        .modal-overlay { /* ... (Your existing styles) ... */ }
        .modal-overlay.active { /* ... (Your existing styles) ... */ }
        .modal-content { /* ... (Your existing styles) ... */ }
        .modal-overlay.active .modal-content { /* ... (Your existing styles) ... */ }
        .modal-close { /* ... (Your existing styles) ... */ }
        .modal-header { /* ... (Your existing styles) ... */ }
        #modal-title { /* ... (Your existing styles) ... */ }
        #modal-courseCode, #modal-description { /* ... (Your existing styles) ... */ }
        #modal-description { /* ... (Your existing styles) ... */ }
        .modal-body { /* ... (Your existing styles) ... */ }
        #modal-embed-preview { /* ... (Your existing styles) ... */ }
    </style>
</head>
<body>
    <!-- (Your existing body HTML: background, header, container, etc.) -->
    <div class="background-container"><div class="aurora-layer"></div><div class="noise-layer"></div></div>
    <main>
        <header class="page-header"><!-- Your Header --></header>
        <div class="container">
            <div class="page-title-header"><!-- Your Page Title --></header>
            <div id="materials-grid" class="materials-grid"></div>
        </div>
    </main>
    <div id="details-modal" class="modal-overlay"><!-- Your Modal --></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('materials-grid');
            const modal = document.getElementById('details-modal');
            const closeBtn = document.getElementById('modal-close-btn');

            const firebaseConfig = { apiKey: "AIzaSyDCmvA9sFCSc5r4ZuFUJuGdO1LDoW7rKao", authDomain: "student-portal-free.firebaseapp.com", projectId: "student-portal-free", storageBucket: "student-portal-free.appspot.com", messagingSenderId: "272865877510", appId: "1:272865877510:web:0875a2502ae55bbf9ead87" };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            let currentUserRole = 'student'; // Default role

            auth.onAuthStateChanged(user => {
                if (user) {
                    // Check user role before loading materials
                    db.collection('users').doc(user.uid).get().then(doc => {
                        if (doc.exists) {
                            currentUserRole = doc.data().role; // Set the user's role
                        }
                        loadMaterials(); // Now load materials with role info
                    }).catch(err => {
                        console.error("Error getting user role:", err);
                        loadMaterials(); // Load as student if role check fails
                    });
                } else {
                    window.location.replace('/index.html');
                }
            });

            function getGoogleDriveEmbedUrl(shareUrl) { /* ... (No change here) ... */ }

            async function loadMaterials() {
                try {
                    const snapshot = await db.collection('materials').orderBy('uploadedAt', 'desc').get();
                    if (snapshot.empty) { /* ... (No change here) ... */ }

                    grid.innerHTML = '';
                    snapshot.forEach(doc => {
                        const material = doc.data();
                        const card = document.createElement('div');
                        card.className = 'material-card';
                        
                        // Add class to make the content clickable, but not the delete button
                        card.innerHTML = `<div class="material-card-clickable"></div>`;

                        const clickableArea = card.querySelector('.material-card-clickable');

                        card.dataset.docId = doc.id; // --- NEW: Store the document ID
                        card.dataset.title = material.title || 'No Title';
                        card.dataset.courseCode = material.courseCode || 'N/A';
                        card.dataset.description = material.description || 'No description available.';
                        card.dataset.downloadUrl = material.downloadURL;
                        card.dataset.embedUrl = getGoogleDriveEmbedUrl(material.downloadURL);
                        card.dataset.isPaid = material.isPaid || false;
                        
                        const isPremium = material.isPaid || false;
                        const placeholderImg = 'https://via.placeholder.com/400x180.png?text=No+Preview';
                        const thumbnailSrc = (material.thumbnailURL && material.thumbnailURL.trim() !== '') ? material.thumbnailURL : placeholderImg;

                        // --- NEW: Conditionally add delete button HTML ---
                        let deleteButtonHtml = '';
                        if (currentUserRole === 'admin') {
                            deleteButtonHtml = `<button class="delete-btn" title="Delete Material"><i class="fas fa-trash"></i></button>`;
                        }

                        clickableArea.innerHTML = `
                            <div class="card-thumbnail">
                                ${deleteButtonHtml} 
                                <img src="${thumbnailSrc}" alt="${material.title} preview" onerror="this.onerror=null; this.src='${placeholderImg}';">
                            </div>
                            <div class="card-content-wrapper">
                                <div class="material-info">
                                    <h3 class="material-title">${material.title}</h3>
                                    <p class="material-meta">Course: ${material.courseCode}</p>
                                </div>
                                <div class="material-footer">
                                    <span class="tag ${isPremium ? 'tag-premium' : 'tag-free'}">${isPremium ? 'Premium' : 'Free'}</span>
                                    <i class="fas ${isPremium ? 'fa-lock' : 'fa-eye'} material-action-icon"></i>
                                </div>
                            </div>
                        `;

                        grid.appendChild(card);
                    });
                } catch (err) { /* ... (No change here) ... */ }
            }

            // --- NEW: Event Listener for Clicks on the Grid ---
            grid.addEventListener('click', e => {
                const card = e.target.closest('.material-card');
                if (!card) return; // Exit if click wasn't inside a card

                // Check if the delete button was clicked
                if (e.target.closest('.delete-btn')) {
                    const docId = card.dataset.docId;
                    const title = card.dataset.title;
                    
                    if (confirm(`Are you sure you want to permanently delete "${title}"?`)) {
                        db.collection('materials').doc(docId).delete()
                            .then(() => {
                                console.log("Document successfully deleted!");
                                card.remove(); // Remove card from the view
                            })
                            .catch((error) => {
                                console.error("Error removing document: ", error);
                                alert("Could not delete the material. Please try again.");
                            });
                    }
                } 
                // Otherwise, if the clickable area was clicked, open the modal
                else if (e.target.closest('.material-card-clickable')) {
                    if (card.dataset.isPaid === 'true') {
                        alert('This is a premium resource! Please contact the admin for access.');
                        return;
                    }
                    
                    document.getElementById('modal-title').textContent = card.dataset.title;
                    document.getElementById('modal-courseCode').textContent = card.dataset.courseCode;
                    document.getElementById('modal-description').textContent = card.dataset.description;
                    document.getElementById('modal-download-btn').href = card.dataset.downloadUrl;
                    document.getElementById('modal-embed-preview').src = card.dataset.embedUrl;
                    modal.classList.add('active');
                }
            });
            
            // --- Modal closing logic (No change) ---
            const closeModal = () => { /* ... */ };
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.getElementById('logout-btn').addEventListener('click', (e) => { /* ... */ });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Materials | IB STUDIOZ</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23FFD700' d='M50,2 A48,48 0 1,0 50,98 A48,48 0 1,0 50,2 Z' /%3E%3Cg fill='%230A0A0A'%3E%3Cpath d='M28,25 h10 v50 h-10 Z' /%3E%3Cpath d='M45,25 H60 A12.5,12.5 0 0,1 60,50 H45 Z M45,50 H63 A12.5,12.5 0 0,1 63,75 H45 Z' /%3E%3C/g%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-glow: #FFD700; --secondary-glow: #00A2FF; --dark-bg: #0A0A0A;
            --text-primary: #F0F0F0; --text-secondary: #A0A0A0; --card-bg: rgba(22, 22, 22, 0.8);
            --border-color: rgba(255, 215, 0, 0.2); --shadow-color: rgba(0, 0, 0, 0.5);
            --primary-glow-transparent: rgba(255, 215, 0, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--dark-bg);
            color: var(--text-primary); line-height: 1.6;
            opacity: 0;
            animation: page-fade-in 0.4s ease-out forwards;
        }
        @keyframes page-fade-in { 
            to { opacity: 1; } 
        }
        
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
        .aurora-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 10% 20%, var(--primary-glow) 0%, transparent 25%), radial-gradient(circle at 80% 30%, var(--secondary-glow) 0%, transparent 30%), radial-gradient(circle at 50% 80%, var(--primary-glow) 0%, transparent 25%); animation: aurora-morph 40s linear infinite alternate; filter: blur(120px); opacity: 0.2; }
        @keyframes aurora-morph { 0% { transform: rotate(0deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1.8); } }
        .noise-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)"/></svg>'); opacity: 0.015; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; margin: 20px; background: rgba(16,16,16,0.6); backdrop-filter: blur(20px); border-radius: 15px; border: 1px solid var(--border-color); }
        .brand-logo { display: flex; align-items: center; gap: 15px; text-decoration: none; }
        .header-logo-svg { width: 45px; height: auto; }
        .brand-title { position: relative; font-size: 1.5rem; font-weight: 700; background: linear-gradient(90deg, #ff00ff, #00ffea, #ffdd00, #ff00ff); background-size: 400% 100%; -webkit-background-clip: text; background-clip: text; color: transparent; animation: rgb-text-flow 6s linear infinite; }
        .brand-title::before { content: 'IB STUDIOZ'; position: absolute; top: 0; left: 0; z-index: -1; background: linear-gradient(90deg, #ff00ff, #00ffea, #ffdd00, #ff00ff); background-size: 400% 100%; -webkit-background-clip: text; background-clip: text; color: transparent; filter: blur(20px) opacity(0.9); transform: scale(1.1); animation: rgb-text-flow 6s linear infinite; }
        @keyframes rgb-text-flow { to { background-position: 400% 0; } }
        .btn, .btn-secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 10px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
        .btn-secondary:hover { background: var(--primary-glow); color: var(--dark-bg); border-color: var(--primary-glow); box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        .btn-secondary .fas { margin-right: 8px; }
        .btn-primary { background: var(--primary-glow); color: var(--dark-bg); font-weight: 600; width: 100%; text-align: center; }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        .page-title-header { padding: 40px 0; margin-bottom: 20px; border-left: 4px solid; border-image: linear-gradient(to bottom, var(--primary-glow), var(--secondary-glow)) 1; padding-left: 30px; }
        .page-title-header h1 { font-size: clamp(2.2rem, 5vw, 3.2rem); font-weight: 700; line-height: 1.2; margin-bottom: 10px; }
        .page-title-header p { font-size: 1.1rem; color: var(--text-secondary); max-width: 600px; }

        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        .filter-group {
            flex: 1;
        }
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        select.filter-select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: rgba(10, 10, 10, 0.8);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
        }
        select.filter-select:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .materials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        
        .material-card {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 15px; overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; flex-direction: column;
            cursor: pointer;
        }
        .material-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 25px var(--primary-glow-transparent);
        }
        .card-thumbnail {
            width: 100%; height: 180px; overflow: hidden;
        }
        .card-thumbnail img {
            width: 100%; height: 100%; object-fit: cover; display: block; background-color: #333;
        }
        .card-content-wrapper {
            padding: 20px 25px; flex-grow: 1; display: flex; flex-direction: column;
        }
        .material-title { font-size: 1.3rem; margin-bottom: 8px; color: var(--text-primary); }
        .material-meta { font-size: 0.9rem; color: var(--text-secondary); }
        .material-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .tag { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .tag-free { background-color: rgba(16, 185, 129, 0.2); color: #10B981; }
        .tag-premium { background-color: rgba(255, 179, 71, 0.2); color: #ffb347; }
        .material-action-icon { font-size: 1.5rem; color: var(--text-secondary); }
        .material-card:hover .material-action-icon { color: var(--primary-glow); }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 50px; background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border-color); }
        .empty-state i { font-size: 3rem; color: var(--primary-glow); margin-bottom: 20px; display: block; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--dark-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--border-color); width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: var(--text-primary); font-size: 2rem; cursor: pointer; }
        .modal-header { margin-bottom: 20px; }
        #modal-title { font-size: 1.8rem; margin-bottom: 5px; }
        #modal-courseCode, #modal-description { color: var(--text-secondary); }
        #modal-description { margin-top: 10px; }
        .modal-body { flex-grow: 1; overflow-y: auto; margin-bottom: 20px;}
        #modal-embed-preview { border-radius: 8px; }
    </style>
</head>
<body>
    <div class="background-container"><div class="aurora-layer"></div><div class="noise-layer"></div></div>

    <main>
        <header class="page-header">
            <a href="/studentdashboard.html" class="brand-logo">
                <svg class="header-logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path fill="var(--primary-glow)" d="M50,2 A48,48 0 1,0 50,98 A48,48 0 1,0 50,2 Z" /><g fill="var(--dark-bg)"><path d="M28,25 h10 v50 h-10 Z" /><path d="M45,25 H60 A12.5,12.5 0 0,1 60,50 H45 Z M45,50 H63 A12.5,12.5 0 0,1 63,75 H45 Z" /></g></svg>
                <h1 class="brand-title">IB STUDIOZ</h1>
            </a>
            <a href="#" id="logout-btn" class="btn-secondary"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </header>
        <div class="container">
            <div class="page-title-header">
                <h1>Study Materials</h1>
                <p>Your central hub for course notes, e-books, and essential learning resources.</p>
            </div>

            <div class="filters-container">
                <div class="filter-group">
                    <label for="department-select"><i class="fas fa-university"></i> Select Department</label>
                    <select id="department-select" class="filter-select">
                        <option value="">-- Choose a Department --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="semester-select"><i class="fas fa-graduation-cap"></i> Select Semester</label>
                    <select id="semester-select" class="filter-select" disabled>
                        <option value="">-- Choose a Semester --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="course-select"><i class="fas fa-book"></i> Select Course</label>
                    <select id="course-select" class="filter-select" disabled>
                        <option value="">-- Choose a Course --</option>
                    </select>
                </div>
            </div>

            <div id="materials-grid" class="materials-grid">
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <p>Please select a department to begin.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close">&times;</button>
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <p><strong>Course:</strong> <span id="modal-courseCode"></span></p>
                <p id="modal-description"></p>
            </div>
            <div class="modal-body">
                <iframe id="modal-embed-preview" src="" width="100%" height="500" frameborder="0"></iframe>
            </div>
            <a id="modal-download-btn" href="#" target="_blank" class="btn btn-primary">
                <i class="fas fa-download"></i> Download File
            </a>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // Full academic data structure for departments, semesters, and subjects
        const academicData = {
            branches: {"CSE":{"name":"Computer Science","color":"var(--cse-color)","icon":"fas fa-laptop-code","semesters":{"1":[{"code":"U23ENG101A","name":"Communication Skills in English","credits":3},{"code":"U23MAT102A","name":"Linear Algebra and Calculus With MATLAB","credits":4},{"code":"U23PHY103B","name":"Engineering Physics","credits":3},{"code":"U23PPR105","name":"Problem Solving using Python Programming","credits":3},{"code":"U23BEE106A","name":"Basic Electrical and Electronics Engineering","credits":3},{"code":"U23TAM101","name":"Heritage of Tamils","credits":1},{"code":"U23PHL110","name":"Engineering Physics Lab","credits":1},{"code":"U23BEEL113","name":"Basic Electrical and Electronics Engineering Lab","credits":1},{"code":"U23PPL112","name":"Python Programming Lab","credits":1}],"2":[{"code":"U23ENG201A","name":"Technical English","credits":2},{"code":"U23MAT202B","name":"Discrete Mathematics","credits":4},{"code":"U23CHE204B","name":"Chemistry For Computer Science","credits":3},{"code":"U23CPR205B","name":"Programming In C","credits":3},{"code":"U23EGR207","name":"Engineering Graphics","credits":3},{"code":"U23EC203","name":"Digital Principles And System Design","credits":3},{"code":"U23CHL211","name":"Chemistry Lab","credits":1},{"code":"U23CPL212","name":"C programming Lab","credits":1},{"code":"U23TAM201","name":"Tamils And Technology","credits":1}],"3":[{"code":"U23MAT301D","name":"Probability and Statistics","credits":4},{"code":"U23CS301","name":"Data Structures","credits":3},{"code":"U23CS302","name":"Computer Architecture","credits":3},{"code":"U23CS303","name":"Object Oriented Programming","credits":3},{"code":"U23CS304","name":"Operating Systems","credits":3},{"code":"U23CS305","name":"Computer Information and Ethics","credits":3},{"code":"U23CS306","name":"Data Structures Lab","credits":1},{"code":"U23CS307","name":"Object Oriented Programming Lab","credits":1},{"code":"U23GE301","name":"Soft Skills and Aptitude-I","credits":1},{"code":"Noc24-mg72","name":"NPTEL:design Thinking-A Primer","credits":1}],"4":[{"code":"U23MAT401B","name":"Numerical Methods","credits":4},{"code":"U23CS401","name":"Design And Analysis of Algorithms","credits":3},{"code":"U23CS402","name":"Software Engineering","credits":3},{"code":"U23CS403","name":"DataBase Management Systems","credits":3},{"code":"U23CS404","name":"Embedded System Design ","credits":3},{"code":"U23CS405","name":"Software Development Lab","credits":1},{"code":"U23CS403","name":"Database Management Systems Lab","credits":1}],"5":[{"code":"U23CS504","name":"Machine Learning","credits":3},{"code":"U23CS501","name":"Computer Networks","credits":3},{"code":"U23CS502","name":"Artificial Intelligence","credits":3},{"code":"U23CS503","name":"Theory of Computation","credits":3},{"code":"noc25-cs135","name":"Elective NPTEL","credits":3},{"code":" U23CS947 / U23CS903","name":"Professional Elective ","credits":3},{"code":"U23CS505","name":"Computer Networks Laboratory","credits":2},{"code":"U23CS506","name":"Artificial Intelligence and Machine Learning Laboratory","credits":1},{"code":"U23GE501","name":"Soft Skills and Aptitude -III","credits":1}],"6":[],"7":[],"8":[]}},
            "IT":{"name":"Info. Technology","color":"var(--it-color)","icon":"fas fa-network-wired","semesters":{"1":[{"code":"U23IT101","name":"Programming Fundamentals","credits":4}],"2":[{"code":"U23IT201","name":"Data Structures","credits":4}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
            "ECE":{"name":"Electronics & Comm","color":"var(--ece-color)","icon":"fas fa-satellite-dish","semesters":{"1":[{"code":"U23EC101","name":"Basic Electronics","credits":4}],"2":[{"code":"U23EC201","name":"Analog Electronics","credits":4}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
            "EEE":{"name":"Electrical & Electronics","color":"var(--eee-color)","icon":"fas fa-bolt","semesters":{"1":[{"code":"U23EE101","name":"Basic Electrical Engineering","credits":4}],"2":[{"code":"U23EE201","name":"Circuit Theory","credits":4}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
            "MECH":{"name":"Mechanical","color":"var(--mech-color)","icon":"fas fa-cogs","semesters":{"1":[{"code":"U23ME101","name":"Engineering Mechanics","credits":4}],"2":[{"code":"U23ME201","name":"Thermodynamics","credits":4}],"3":[],"4":[],"5":[],"6":[],"7":[],"8":[]}},
            "AIML":{"name":"AI & Machine Learning","color":"var(--aiml-color)","icon":"fas fa-brain","semesters":{"1":[{"code":"U23EG107","name":"Engineering Graphics","credits":3}],"2":[{"code":"U23ENG201A","name":"Technical English","credits":2}],"3":[{"code":"U23MAT301E","name":"Applied Probability and Statistics-I","credits":4}],"4":[{"code":"U23MAT401A","name":"Applied Probability and Statistics-II","credits":4}],"5":[{"code":"U23CS504","name":"Machine Learning","credits":3}],"6":[{"code":"U23CS601","name":"Computer Vision","credits":3}],"7":[{"code":"U23CS701","name":"Advanced Machine Learning","credits":3}],"8":[{"code":"U23CS801","name":"Industry Internship","credits":6}]}},
            "CIVIL":{"name":"Civil Engineering","color":"var(--civil-color)","icon":"fas fa-building","semesters":{"1":[{"code":"U23CE101","name":"Engineering Mechanics","credits":4}],"2":[{"code":"U23CE201","name":"Building Materials","credits":4}]}},
            "BME":{"name":"Bio Medical","color":"var(--bme-color)","icon":"fas fa-heartbeat","semesters":{"1":[{"code":"U23BM101","name":"Human Anatomy","credits":4}],"2":[{"code":"U23BM201","name":"Human Physiology","credits":4}]}},
            "FT":{"name":"Fashion Technology","color":"var(--ft-color)","icon":"fas fa-tshirt","semesters":{"1":[{"code":"U23FT101","name":"Fiber Science","credits":4}],"2":[{"code":"U23FT201","name":"Textile Processing","credits":4}]}},
            "MCT":{"name":"Mechatronics","color":"var(--mct-color)","icon":"fas fa-robot","semesters":{"1":[{"code":"U23MT101","name":"Engineering Mechanics","credits":4}],"2":[{"code":"U23MT201","name":"Thermodynamics","credits":4}]}},
            "CSD":{"name":"CS & Design","color":"var(--csd-color)","icon":"fas fa-paint-brush","semesters":{"1":[{"code":"U23CD101","name":"Design Fundamentals","credits":4}],"2":[{"code":"U23CD201","name":"User Interface Design","credits":4}]}},
            "ADS":{"name":"AI & Data Science","color":"var(--ads-color)","icon":"fas fa-database","semesters":{"1":[{"code":"U23DS101","name":"Programming Fundamentals","credits":4}],"2":[{"code":"U23DS201","name":"Data Structures","credits":4}]}},
            "EFE":{"name":"Electrical & Computer","color":"var(--efe-color)","icon":"fas fa-microchip","semesters":{"1":[{"code":"U23EF101","name":"Circuit Theory","credits":4}],"2":[{"code":"U23EF201","name":"Signals and Systems","credits":4}]}},
            "EXE":{"name":"Electronics & Computer","color":"var(--exe-color)","icon":"fas fa-desktop","semesters":{"1":[{"code":"U23EX101","name":"Basic Electronics","credits":4}],"2":[{"code":"U23EX201","name":"Data Structures","credits":4}]}}}
        };

        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('materials-grid');
            const modal = document.getElementById('details-modal');
            const closeBtn = document.getElementById('modal-close-btn');
            const departmentSelect = document.getElementById('department-select');
            const semesterSelect = document.getElementById('semester-select');
            const courseSelect = document.getElementById('course-select');

            const firebaseConfig = { apiKey: "AIzaSyDCmvA9sFCSc5r4ZuFUJuGdO1LDoW7rKao", authDomain: "student-portal-free.firebaseapp.com", projectId: "student-portal-free", storageBucket: "student-portal-free.appspot.com", messagingSenderId: "272865877510", appId: "1:272865877510:web:0875a2502ae55bbf9ead87" };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            auth.onAuthStateChanged(user => user ? initializePage() : window.location.replace('/index.html'));
            
            function initializePage() {
                populateDepartments();
                departmentSelect.addEventListener('change', handleDepartmentChange);
                semesterSelect.addEventListener('change', handleSemesterChange);
                courseSelect.addEventListener('change', handleCourseChange);
            }

            function populateDepartments() {
                Object.keys(academicData.branches).forEach(branchCode => {
                    const branch = academicData.branches[branchCode];
                    const option = document.createElement('option');
                    option.value = branchCode;
                    option.textContent = branch.name;
                    departmentSelect.appendChild(option);
                });
            }

            function handleDepartmentChange() {
                const selectedBranch = departmentSelect.value;
                semesterSelect.innerHTML = '<option value="">-- Choose a Semester --</option>';
                courseSelect.innerHTML = '<option value="">-- Choose a Course --</option>';
                semesterSelect.disabled = true;
                courseSelect.disabled = true;
                grid.innerHTML = `<div class="empty-state"><i class="fas fa-arrow-up"></i><p>Please select a semester to continue.</p></div>`;

                if (selectedBranch) {
                    semesterSelect.disabled = false;
                    const branchData = academicData.branches[selectedBranch];
                    Object.keys(branchData.semesters).forEach(sem => {
                        const option = document.createElement('option');
                        option.value = sem;
                        option.textContent = `Semester ${sem}`;
                        semesterSelect.appendChild(option);
                    });
                }
            }

            function handleSemesterChange() {
                const department = departmentSelect.value;
                const semester = semesterSelect.value;
                courseSelect.innerHTML = '<option value="">-- Choose a Course --</option>';
                courseSelect.disabled = true;
                grid.innerHTML = `<div class="empty-state"><i class="fas fa-book-open"></i><p>Please select a course to view materials.</p></div>`;

                if (department && semester) {
                    courseSelect.disabled = false;
                    const subjects = academicData.branches[department].semesters[semester];
                    if (subjects && subjects.length > 0) {
                        subjects.forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject.code;
                            option.textContent = `${subject.code} - ${subject.name}`;
                            courseSelect.appendChild(option);
                        });
                    } else {
                         courseSelect.innerHTML = '<option value="">-- No courses found --</option>';
                         courseSelect.disabled = true;
                    }
                }
            }

            function handleCourseChange() {
                const department = departmentSelect.value;
                const semester = semesterSelect.value;
                const courseCode = courseSelect.value;

                if (department && semester && courseCode) {
                    loadMaterials(department, semester, courseCode);
                } else {
                    grid.innerHTML = `<div class="empty-state"><i class="fas fa-hand-pointer"></i><p>Please complete your selection to view materials.</p></div>`;
                }
            }

            function getGoogleDriveEmbedUrl(shareUrl) {
                if (!shareUrl) return '';
                const fileIdMatch = shareUrl.match(/d\/([a-zA-Z0-9_-]{25,})/);
                return fileIdMatch && fileIdMatch[1] ? `https://drive.google.com/file/d/${fileIdMatch[1]}/preview` : shareUrl;
            }

            async function loadMaterials(department, semester, courseCode) {
                grid.innerHTML = `<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading materials...</p></div>`;
                
                // --- NEW: Find the full course name from academicData ---
                let courseName = '';
                try {
                    const subjects = academicData.branches[department].semesters[semester];
                    const currentSubject = subjects.find(sub => sub.code === courseCode);
                    if (currentSubject) {
                        courseName = currentSubject.name;
                    }
                } catch (e) {
                    console.warn("Could not find subject details in academicData:", e);
                }

                try {
                    const snapshot = await db.collection('materials')
                                           .where('department', '==', department)
                                           .where('semester', '==', semester)
                                           .where('courseCode', '==', courseCode)
                                           .orderBy('uploadedAt', 'desc')
                                           .get();

                    if (snapshot.empty) {
                        grid.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><p>No study materials found for this course.</p></div>`;
                        return;
                    }

                    grid.innerHTML = '';
                    snapshot.forEach(doc => {
                        const material = doc.data();
                        const card = document.createElement('div');
                        card.className = 'material-card';

                        card.dataset.title = material.title || 'No Title';
                        card.dataset.courseCode = material.courseCode || 'N/A';
                        card.dataset.description = material.description || 'No description available.';
                        card.dataset.downloadUrl = material.downloadURL;
                        card.dataset.embedUrl = getGoogleDriveEmbedUrl(material.downloadURL);
                        card.dataset.isPaid = material.isPaid || false;
                        
                        const isPremium = material.isPaid || false;
                        const placeholderImg = 'https://via.placeholder.com/400x180.png?text=No+Preview';
                        const thumbnailSrc = (material.thumbnailURL && material.thumbnailURL.trim() !== '') ? material.thumbnailURL : placeholderImg;
                        
                        // --- UPDATED: Create a display name with both code and name ---
                        const courseDisplayName = courseName ? `${material.courseCode} - ${courseName}` : material.courseCode;

                        card.innerHTML = `
                            <div class="card-thumbnail">
                                <img src="${thumbnailSrc}" alt="${material.title} preview" onerror="this.onerror=null; this.src='${placeholderImg}';">
                            </div>
                            <div class="card-content-wrapper">
                                <div class="material-info">
                                    <h3 class="material-title">${material.title}</h3>
                                    <p class="material-meta">Course: ${courseDisplayName}</p>
                                </div>
                                <div class="material-footer">
                                    <span class="tag ${isPremium ? 'tag-premium' : 'tag-free'}">${isPremium ? 'Premium' : 'Free'}</span>
                                    <i class="fas ${isPremium ? 'fa-lock' : 'fa-eye'} material-action-icon"></i>
                                </div>
                            </div>
                        `;

                        card.addEventListener('click', () => {
                            if (card.dataset.isPaid === 'true') {
                                alert('This is a premium resource! Please contact the admin for access.');
                                return;
                            }
                            
                            document.getElementById('modal-title').textContent = card.dataset.title;
                            // --- UPDATED: Use the display name in the modal as well ---
                            document.getElementById('modal-courseCode').textContent = courseDisplayName;
                            document.getElementById('modal-description').textContent = card.dataset.description;
                            document.getElementById('modal-download-btn').href = card.dataset.downloadUrl;
                            document.getElementById('modal-embed-preview').src = card.dataset.embedUrl;
                            modal.classList.add('active');
                        });
                        
                        grid.appendChild(card);
                    });
                } catch (err) {
                    console.error("Error loading materials:", err);
                    grid.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Could not load materials. Please check your Firestore rules and try again.</p></div>`;
                }
            }
            
            const closeModal = () => {
                modal.classList.remove('active');
                document.getElementById('modal-embed-preview').src = '';
            };

            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut();
            });
        });
    </script>
</body>
</html>
